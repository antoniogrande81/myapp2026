<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - MyApp</title>
    <!-- PWA Meta Tags -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#2400C1">
    <meta name="background-color" content="#2400C1">

    <!-- Icone Standard -->
    <link rel="icon" type="image/png" sizes="16x16" href="/public/icons/favicon-16x16.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/public/icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="/public/icons/favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="192x192" href="/public/icons/icon-192x192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="/public/icons/icon-512x512.png">

    <!-- iOS Support -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="MyApp">
    <link rel="apple-touch-icon" href="/public/icons/apple-touch-icon.png">

    <!-- Android Support -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="MyApp">
    <meta name="msapplication-TileColor" content="#2400C1">
    
    <!-- Preconnect per performance -->
    <link rel="preconnect" href="https://cdn.tailwindcss.com">
    <link rel="preconnect" href="https://cdn.jsdelivr.net">
    <link rel="preconnect" href="https://lycrgzptkdkksukcwrld.supabase.co">


    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: linear-gradient(135deg, #2400C1, #8E008C);
            font-family: 'Segoe UI', Arial, sans-serif;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .container {
            background: white;
            padding: 2rem;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            width: 100%;
            max-width: 400px;
            margin: 1rem;
        }
        
        .header {
            text-align: center;
            margin-bottom: 2rem;
        }
        
        .header h1 {
            color: #2400C1;
            margin-bottom: 0.5rem;
        }
        
        .header p {
            color: #666;
            font-size: 0.9rem;
        }
        
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #333;
        }
        
        input {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }
        
        input:focus {
            outline: none;
            border-color: #2400C1;
        }
        
        .btn {
            width: 100%;
            padding: 0.75rem;
            background: #2400C1;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .btn:hover {
            background: #1a0099;
        }
        
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .message {
            padding: 0.75rem;
            margin: 1rem 0;
            border-radius: 6px;
            text-align: center;
            font-size: 0.9rem;
        }
        
        .error {
            background: #ffebee;
            color: #c62828;
            border: 1px solid #e57373;
        }
        
        .success {
            background: #e8f5e8;
            color: #2e7d32;
            border: 1px solid #81c784;
        }
        
        .info {
            background: #e3f2fd;
            color: #1565c0;
            border: 1px solid #64b5f6;
        }
        
        .back-link {
            text-align: center;
            margin-top: 1rem;
        }
        
        .back-link a {
            color: #2400C1;
            text-decoration: none;
            font-size: 0.9rem;
        }
        
        .debug-info {
            background: #fff3e0;
            color: #ef6c00;
            border: 1px solid #ffb74d;
            padding: 0.5rem;
            margin-top: 1rem;
            border-radius: 4px;
            font-size: 0.8rem;
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîê Login MyApp</h1>
            <p>Accedi al tuo account</p>
        </div>
        
        <div id="messages"></div>
        
        <div id="loginContainer">
            <form id="loginForm">
                <div class="form-group">
                    <label for="email">Email</label>
                    <input type="email" id="email" value="test@test.com" required>
                </div>
                
                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" value="test123456" required>
                </div>
                
                <button type="submit" class="btn" id="loginBtn">
                    Accedi
                </button>
            </form>
        </div>
        
        <div class="back-link">
            <a href="index.html">‚Üê Torna alla home</a>
        </div>
        
        <div class="debug-info" id="debugInfo">
            <strong>Debug Info:</strong><br>
            <span id="debugText"></span>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Evita che il form si ricarichi
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Page loaded');
            showMessage('Pagina caricata correttamente', 'info');
            
            // Setup form handler
            const form = document.getElementById('loginForm');
            const loginBtn = document.getElementById('loginBtn');
            
            form.addEventListener('submit', function(event) {
                event.preventDefault(); // CRITICO: Previene reload
                event.stopPropagation();
                
                console.log('üìù Form submitted - no reload');
                showMessage('Form inviato! Tentativo login...', 'info');
                
                handleLogin();
                
                return false; // Extra protezione
            });
            
            // Test Supabase connection
            testSupabaseConnection();
        });
        
        // Configurazione Supabase
        const { createClient } = supabase;
        const supabaseClient = createClient(
            'https://lycrgzptkdkksukcwrld.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx5Y3JnenB0a2Rra3N1a2N3cmxkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI3ODQyMzAsImV4cCI6MjA2ODM2MDIzMH0.ZJGOXAMC3hKKrnwXHKEa2_Eh7ZpOKeLYvYlYneBiEfk'
        );
        
        function showMessage(text, type = 'info') {
            const messagesDiv = document.getElementById('messages');
            messagesDiv.innerHTML = `<div class="message ${type}">${text}</div>`;
            console.log(`[${type.toUpperCase()}] ${text}`);
            
            // Debug info
            const debugInfo = document.getElementById('debugInfo');
            const debugText = document.getElementById('debugText');
            debugText.innerHTML = `${new Date().toLocaleTimeString()}: ${text}`;
            debugInfo.style.display = 'block';
        }
        
        function setLoading(loading) {
            const loginBtn = document.getElementById('loginBtn');
            loginBtn.disabled = loading;
            loginBtn.textContent = loading ? '‚è≥ Accesso in corso...' : 'Accedi';
        }
        
        async function testSupabaseConnection() {
            try {
                showMessage('üîß Test connessione Supabase...', 'info');
                
                const { data, error } = await supabaseClient.auth.getSession();
                
                if (error) {
                    throw error;
                }
                
                showMessage('‚úÖ Supabase connesso correttamente!', 'success');
                return true;
            } catch (error) {
                showMessage(`‚ùå Errore Supabase: ${error.message}`, 'error');
                return false;
            }
        }
        
        async function getUserRole(userId) {
            try {
                showMessage('üîç Controllo ruolo utente...', 'info');
                
                // Query per ottenere il profilo dell'utente con i ruoli (array JSON)
                const { data: profile, error } = await supabaseClient
                    .from('profiles')
                    .select('ruoli, nome, cognome, email, telefono')
                    .eq('id', userId)
                    .single();
                
                if (error) {
                    console.error('‚ùå Errore recupero profilo:', error);
                    throw new Error(`Errore recupero profilo: ${error.message}`);
                }
                
                if (!profile) {
                    throw new Error('Profilo utente non trovato');
                }
                
                console.log('üë§ Profilo utente:', profile);
                
                // Gestione array di ruoli - controlla se contiene "DIRIGENTE"
                const ruoli = profile.ruoli || ['USER'];
                const isDirigente = ruoli.includes('DIRIGENTE');
                const isAdmin = ruoli.includes('ADMIN');
                
                // Determina il ruolo principale per il redirect
                let ruoloPrincipale = 'USER';
                if (isAdmin) {
                    ruoloPrincipale = 'ADMIN';
                } else if (isDirigente) {
                    ruoloPrincipale = 'DIRIGENTE';
                }
                
                const ruoliStr = ruoli.join(', ');
                showMessage(`‚úÖ Profilo caricato: ${profile.nome || 'Utente'} - Ruoli: [${ruoliStr}]`, 'success');
                
                return {
                    ...profile,
                    ruolo: ruoloPrincipale, // Ruolo principale per il redirect
                    ruoli: ruoli,           // Array completo dei ruoli
                    isDirigente: isDirigente,
                    isAdmin: isAdmin
                };
                
            } catch (error) {
                console.error('‚ùå Errore getUserRole:', error);
                showMessage(`‚ùå Errore controllo ruolo: ${error.message}`, 'error');
                
                // In caso di errore, ritorna un ruolo di default
                return { 
                    ruolo: 'USER', 
                    ruoli: ['USER'],
                    nome: 'Utente', 
                    email: '', 
                    cognome: '',
                    isDirigente: false,
                    isAdmin: false
                };
            }
        }
        
        function getRedirectUrl(userProfile) {
            const ruoli = userProfile.ruoli || ['USER'];
            const isDirigente = userProfile.isDirigente;
            const isAdmin = userProfile.isAdmin;
            
            // Priorit√†: ADMIN > DIRIGENTE > USER
            if (isAdmin) {
                showMessage('üéØ Reindirizzamento a Dashboard Admin...', 'success');
                return 'app/home_dirigenti.html'; // Gli admin vanno alla stessa dashboard dei dirigenti per ora
            } else if (isDirigente) {
                showMessage('üéØ Reindirizzamento a Dashboard Dirigenti...', 'success');
                return 'app/home_dirigenti.html';
            } else {
                showMessage('üéØ Reindirizzamento a Dashboard Utente...', 'success');
                return 'app/home.html';
            }
        }
        
        async function handleLogin() {
            try {
                setLoading(true);
                
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;
                
                showMessage(`üîë Tentativo login con ${email}...`, 'info');
                
                if (!email || !password) {
                    throw new Error('Email e password obbligatorie');
                }
                
                // Chiamata Supabase per l'autenticazione
                const { data, error } = await supabaseClient.auth.signInWithPassword({
                    email: email,
                    password: password
                });
                
                if (error) {
                    throw error;
                }
                
                if (data && data.user) {
                    showMessage(`‚úÖ Login riuscito! Benvenuto ${data.user.email}`, 'success');
                    
                    // NUOVO: Controllo del ruolo utente
                    const userProfile = await getUserRole(data.user.id);
                    
                    // Determina la pagina di destinazione in base ai ruoli
                    const redirectUrl = getRedirectUrl(userProfile);
                    
                    const ruoliStr = userProfile.ruoli ? userProfile.ruoli.join(', ') : 'USER';
                    showMessage(`üë§ Ruoli: [${ruoliStr}] - Reindirizzamento in corso...`, 'info');
                    
                    // Redirect dopo 2 secondi
                    setTimeout(() => {
                        console.log(`üîÑ Redirect to: ${redirectUrl}`);
                        window.location.href = redirectUrl;
                    }, 2000);
                    
                } else {
                    throw new Error('Nessun dato utente ricevuto');
                }
                
            } catch (error) {
                console.error('‚ùå Login error:', error);
                showMessage(`‚ùå Errore: ${error.message}`, 'error');
                
                // Suggerimenti in base all'errore
                if (error.message.includes('Invalid login credentials')) {
                    showMessage('üí° Verifica email e password, o crea un account su Supabase', 'error');
                } else if (error.message.includes('Email not confirmed')) {
                    showMessage('üìß Conferma la tua email prima di accedere', 'error');
                } else if (error.message.includes('Errore recupero profilo')) {
                    showMessage('‚ö†Ô∏è Login riuscito ma errore nel recupero del profilo. Reindirizzamento alla dashboard utente...', 'info');
                    
                    // In caso di errore nel recupero del profilo, reindirizza comunque alla dashboard utente
                    setTimeout(() => {
                        window.location.href = 'app/home.html';
                    }, 3000);
                }
                
            } finally {
                setLoading(false);
            }
        }
        
        // Debug extra - log tutti gli eventi
        window.addEventListener('error', function(e) {
            console.error('üí• JavaScript Error:', e.error);
            showMessage(`üí• Errore JS: ${e.error.message}`, 'error');
        });
        
        window.addEventListener('unhandledrejection', function(e) {
            console.error('üí• Unhandled Promise:', e.reason);
            showMessage(`üí• Promise Error: ${e.reason}`, 'error');
        });
        
    </script>
</body>
</html>
