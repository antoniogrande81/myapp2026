<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Virgilio - MyApp</title>

    <!-- PWA -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#2400C1">
    <meta name="background-color" content="#2400C1">

    <!-- Icone -->
    <link rel="icon" type="image/png" sizes="16x16" href="/icons/favicon-16x16.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="/icons/favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="192x192" href="/icons/icon-192x192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="/icons/icon-512x512.png">
    <link rel="apple-touch-icon" href="/icons/apple-touch-icon.png">

<<<<<<< HEAD
    <!-- iOS Support -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="MyApp">
    <link rel="apple-touch-icon" href="/public/icons/apple-touch-icon.png">

    <!-- Android Support -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="MyApp">
    <meta name="msapplication-TileColor" content="#2400C1">
    
    <!-- Preconnect per performance -->
    <link rel="preconnect" href="https://cdn.tailwindcss.com">
    <link rel="preconnect" href="https://cdn.jsdelivr.net">
    <link rel="preconnect" href="https://lycrgzptkdkksukcwrld.supabase.co">

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#2400C1',
                        secondary: '#8E008C', 
                        accent: '#00BFFF',
                        textDark: '#1C1C1E',
                        backgroundLight: '#F4F4F8',
                    }
                }
            }
        }
    </script>
=======
    <!-- Tailwind CSS -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
>>>>>>> d1411ea201200f1b013f73c51a7ac06efbd69d16
    <style>
        :root {
            --primary: #2400C1;
            --secondary: #8E008C;
            --accent: #00BFFF;
            --text-dark: #1C1C1E;
            --background-light: #F4F4F8;
        }
        
        .bg-primary { background-color: var(--primary); }
        .bg-secondary { background-color: var(--secondary); }
        .bg-accent { background-color: var(--accent); }
        .text-primary { color: var(--primary); }
        .text-secondary { color: var(--secondary); }
        .text-accent { color: var(--accent); }
        .text-textDark { color: var(--text-dark); }
        .bg-backgroundLight { background-color: var(--background-light); }
        
        .hover\\:text-primary:hover { color: var(--primary); }
        .hover\\:text-accent:hover { color: var(--accent); }
        .hover\\:bg-opacity-90:hover { background-color: rgba(36, 0, 193, 0.9); }
        body {
            background: linear-gradient(135deg, #2400C1, #8E008C);
            min-height: 100vh;
            font-family: 'Segoe UI', Roboto, sans-serif;
        }
        .glass-effect { 
            background: rgba(255, 255, 255, 0.95); 
            backdrop-filter: blur(10px); 
            border: 1px solid rgba(255, 255, 255, 0.2); 
        }
        .glass-light { 
            background: rgba(255, 255, 255, 0.15); 
            backdrop-filter: blur(10px); 
            border: 1px solid rgba(255, 255, 255, 0.3); 
        }
<<<<<<< HEAD

        .glass-light {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .floating-help {
            position: fixed;
            bottom: 80px;
            right: 20px;
            z-index: 1000;
        }

        .chat-container {
            height: calc(100vh - 200px);
            overflow-y: auto;
            scroll-behavior: smooth;
        }

        .message-user {
            background: linear-gradient(135deg, #2400C1, #8E008C);
        }

=======
>>>>>>> d1411ea201200f1b013f73c51a7ac06efbd69d16
        .message-bot {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        .message-user {
            background: linear-gradient(135deg, #2400C1, #8E008C);
            color: white;
            box-shadow: 0 4px 15px rgba(36, 0, 193, 0.3);
        }
        .message-system {
            background: linear-gradient(135deg, #00BFFF, #0099CC);
            color: white;
            box-shadow: 0 4px 15px rgba(0, 191, 255, 0.3);
        }
        .chat-input:focus {
            outline: none;
            box-shadow: 0 0 0 2px rgba(36, 0, 193, 0.3);
        }
        .typing-animation {
            width: 4px;
            height: 4px;
            background: #8E008C;
            border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out;
        }
        .typing-animation:nth-child(2) { animation-delay: 0.2s; }
        .typing-animation:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typing {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }
        .error-message {
            background: rgba(239, 68, 68, 0.9);
            color: white;
        }
        .success-message {
            background: rgba(34, 197, 94, 0.9);
            color: white;
        }
        .animate-fade-in {
            animation: fadeIn 0.4s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .chat-container {
            scrollbar-width: thin;
            scrollbar-color: rgba(255, 255, 255, 0.3) transparent;
        }
        .chat-container::-webkit-scrollbar {
            width: 4px;
        }
        .chat-container::-webkit-scrollbar-track {
            background: transparent;
        }
        .chat-container::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 2px;
        }
        .chat-container::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.5);
        }
        .dirigente-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.2), rgba(255, 255, 255, 0.1));
            border: 1px solid rgba(255, 255, 255, 0.3);
            transition: all 0.3s ease;
        }
        .dirigente-card:hover {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.3), rgba(255, 255, 255, 0.2));
            transform: translateY(-1px);
        }
        .web-search-indicator {
            background: linear-gradient(135deg, #00BFFF, #0099CC);
            color: white;
            font-size: 11px;
            padding: 2px 8px;
            border-radius: 10px;
            display: inline-block;
            margin-bottom: 8px;
        }

        .error-message {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #DC2626;
        }

        .success-message {
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid rgba(34, 197, 94, 0.3);
            color: #16A34A;
        }

        .connection-dot {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .markdown-content strong {
            font-weight: 600;
            color: #1C1C1E;
        }

        .markdown-content em {
            font-style: italic;
            color: #374151;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="w-full px-4 py-4 relative z-10">
        <div class="max-w-md mx-auto flex justify-between items-center">
            <div class="flex items-center space-x-3">
                <button onclick="history.back()" class="text-white hover:text-accent transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                    </svg>
                </button>
                <div class="flex items-center space-x-2">
                    <div class="w-8 h-8 bg-accent rounded-full flex items-center justify-center">
                        <span class="text-white font-bold text-sm">🤖</span>
                    </div>
                    <h1 class="text-xl font-bold text-white drop-shadow-lg">Virgilio</h1>
<<<<<<< HEAD
                    <div id="connectionStatus" class="w-3 h-3 bg-green-500 rounded-full connection-dot" title="Connesso"></div>
                </div>
            </div>
            <div class="flex items-center space-x-2">
                <button id="clearChatBtn" class="bg-yellow-600 hover:bg-yellow-700 text-white text-xs px-3 py-2 rounded-full font-semibold transition-colors shadow-lg border border-yellow-500" title="Pulisci Chat">
                    🗑️
                </button>
                <button id="logoutBtn" class="bg-red-600 hover:bg-red-700 text-white text-sm px-4 py-2 rounded-full font-semibold transition-colors shadow-lg border border-red-500">
                    Logout
                </button>
=======
                    <div id="connectionStatus" class="w-3 h-3 bg-green-500 rounded-full" title="Connesso"></div>
                </div>
            </div>
            <div class="flex items-center space-x-2">
                <button id="clearChatBtn" class="bg-yellow-600 hover:bg-yellow-700 text-white text-xs px-3 py-2 rounded-full font-semibold shadow-lg transition-colors">🗑️</button>
                <button id="logoutBtn" class="bg-red-600 hover:bg-red-700 text-white text-sm px-4 py-2 rounded-full font-semibold shadow-lg transition-colors">Logout</button>
>>>>>>> d1411ea201200f1b013f73c51a7ac06efbd69d16
            </div>
        </div>
    </header>

    <!-- Loading -->
    <div id="loading" class="fixed inset-0 bg-primary bg-opacity-90 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg p-6 text-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary mx-auto mb-4"></div>
            <p class="text-primary font-medium">Caricamento chat...</p>
        </div>
    </div>

    <!-- Main Content -->
<<<<<<< HEAD
    <main class="max-w-md mx-auto px-4 pb-24">
        <!-- Chat Header Info -->
        <div class="glass-light rounded-2xl p-4 mb-4 text-white text-center">
            <h2 class="text-lg font-bold mb-2">Il tuo Assistente Sindacale AI</h2>
            <p class="text-sm opacity-90">Chiedi informazioni su contratti, diritti, procedure e molto altro!</p>
            <div class="text-xs opacity-75 mt-2">
                Powered by OpenAI GPT-4 • Sicuro e Privato
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="mb-4">
            <h3 class="text-white font-semibold mb-3 text-sm">💡 Domande Frequenti</h3>
            <div class="grid grid-cols-2 gap-2">
                <button class="quick-reply glass-light text-white text-xs p-3 rounded-xl hover:bg-opacity-25 transition-all" data-message="Dimmi tutto sul contratto di lavoro dei Carabinieri">
                    📋 Contratto di lavoro
                </button>
                <button class="quick-reply glass-light text-white text-xs p-3 rounded-xl hover:bg-opacity-25 transition-all" data-message="Come funzionano i permessi per malattia?">
                    🏥 Permessi malattia
                </button>
                <button class="quick-reply glass-light text-white text-xs p-3 rounded-xl hover:bg-opacity-25 transition-all" data-message="Quali sono i miei diritti per ferie e permessi?">
                    🏖️ Ferie e permessi
                </button>
                <button class="quick-reply glass-light text-white text-xs p-3 rounded-xl hover:bg-opacity-25 transition-all" data-message="Informazioni su stipendio e progressioni di carriera">
                    💰 Stipendio e aumenti
                </button>
                <button class="quick-reply glass-light text-white text-xs p-3 rounded-xl hover:bg-opacity-25 transition-all" data-message="Diritti sindacali e rappresentanza">
                    ⚖️ Diritti sindacali
                </button>
                <button class="quick-reply glass-light text-white text-xs p-3 rounded-xl hover:bg-opacity-25 transition-all" data-message="Procedure disciplinari e ricorsi">
                    📝 Procedure legali
                </button>
            </div>
        </div>

        <!-- Chat Messages -->
        <div id="chatMessages" class="chat-container mb-4 space-y-4">
            <!-- Welcome Message -->
            <div class="flex items-start space-x-3" id="welcomeMessage">
                <div class="w-8 h-8 bg-accent rounded-full flex items-center justify-center flex-shrink-0">
                    <span class="text-white text-sm">🤖</span>
                </div>
                <div class="message-bot rounded-2xl p-4 max-w-xs">
                    <div class="text-textDark text-sm markdown-content">Ciao! Sono <strong>Virgilio</strong>, il tuo assistente sindacale AI. Sono qui per aiutarti con informazioni su <em>contratti, diritti, procedure</em> e tutto ciò che riguarda la vita professionale dei Carabinieri.<br><br>Come posso aiutarti oggi?</div>
                    <span class="text-xs text-gray-500 mt-2 block">Ora</span>
                </div>
            </div>
=======
    <main class="max-w-lg mx-auto px-4 pb-6 relative">
        <!-- Chat Messages -->
        <div id="chatMessages" class="chat-container space-y-4 overflow-y-auto pb-6" style="height: calc(100vh - 200px); margin-bottom: 140px;">
            <!-- I messaggi verranno caricati qui dinamicamente -->
>>>>>>> d1411ea201200f1b013f73c51a7ac06efbd69d16
        </div>

        <!-- Typing Indicator -->
        <div id="typingIndicator" class="flex items-start space-x-3 hidden mt-4">
            <div class="w-8 h-8 bg-accent rounded-full flex items-center justify-center">
                <span class="text-white text-sm">🤖</span>
            </div>
            <div class="message-bot rounded-2xl p-4 max-w-sm">
                <div class="flex space-x-1">
                    <div class="typing-animation"></div>
                    <div class="typing-animation"></div>
                    <div class="typing-animation"></div>
                </div>
            </div>
        </div>

        <!-- Error Message -->
        <div id="errorMessage" class="error-message rounded-2xl p-4 mb-4 text-center hidden">
            <p class="font-semibold">⚠️ Errore di Connessione</p>
<<<<<<< HEAD
            <p class="text-sm mt-1" id="errorText">Impossibile contattare il server. Riprova tra poco.</p>
            <button onclick="hideError()" class="text-xs underline mt-2">Chiudi</button>
=======
            <p class="text-sm mt-1">Verifica la connessione internet e riprova</p>
>>>>>>> d1411ea201200f1b013f73c51a7ac06efbd69d16
        </div>

        <!-- Success Message -->
        <div id="successMessage" class="success-message rounded-2xl p-4 mb-4 text-center hidden">
            <p class="font-semibold">✅ Operazione Completata</p>
<<<<<<< HEAD
            <p class="text-sm mt-1" id="successText">Chat pulita con successo!</p>
=======
>>>>>>> d1411ea201200f1b013f73c51a7ac06efbd69d16
        </div>
    </main>

    <!-- Chat Input -->
    <div class="fixed bottom-16 left-0 right-0 px-4 pb-4 z-20 bg-gradient-to-t from-purple-900 via-purple-900/95 to-transparent pt-6">
        <div class="max-w-lg mx-auto">
            <div class="glass-effect rounded-2xl p-4 shadow-2xl">
                <div class="flex items-center space-x-3">
<<<<<<< HEAD
                    <input 
                        type="text" 
                        id="messageInput" 
                        placeholder="Scrivi la tua domanda..." 
                        class="chat-input flex-1 bg-transparent border-0 text-textDark placeholder-gray-500 text-sm rounded-xl px-4 py-3 focus:outline-none"
                        maxlength="500"
                        autocomplete="off"
                    />
                    <button 
                        id="sendMessage" 
                        class="bg-primary hover:bg-opacity-90 text-white w-10 h-10 rounded-full flex items-center justify-center transition-all hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed"
                        disabled
                        title="Invia messaggio"
                    >
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
=======
                    <input type="text" id="messageInput" placeholder="Scrivi la tua domanda..." 
                           class="chat-input flex-1 bg-transparent border-0 text-textDark placeholder-gray-500 text-base rounded-xl px-4 py-3" 
                           maxlength="500" autocomplete="off">
                    <button id="sendMessage" 
                            class="bg-primary hover:bg-opacity-90 text-white w-12 h-12 rounded-full flex items-center justify-center disabled:opacity-50 transition-all shadow-lg" 
                            disabled>
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
>>>>>>> d1411ea201200f1b013f73c51a7ac06efbd69d16
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                        </svg>
                    </button>
                </div>
<<<<<<< HEAD
                <div class="flex justify-between items-center mt-2 px-4">
                    <div class="text-xs text-gray-500">
                        <span id="charCount">0</span>/500 caratteri
                    </div>
                    <div class="text-xs text-gray-500" id="tokenInfo">
                        Token utilizzati: <span id="tokenCount">0</span>
=======
                <div class="flex justify-between items-center mt-3 px-4">
                    <div class="text-xs text-gray-500">
                        <span id="charCount">0</span>/500
                    </div>
                    <div class="text-xs text-gray-500">
                        Token: <span id="tokenCount">0</span>
>>>>>>> d1411ea201200f1b013f73c51a7ac06efbd69d16
                    </div>
                </div>
            </div>
        </div>
    </div>

<<<<<<< HEAD
    <!-- Floating Help Button -->
    <button class="floating-help bg-secondary hover:bg-opacity-90 text-white w-14 h-14 rounded-full shadow-lg flex items-center justify-center transition-all hover:scale-110" onclick="showHelp()" title="Aiuto">
        <span class="text-xl">🆘</span>
    </button>

=======
>>>>>>> d1411ea201200f1b013f73c51a7ac06efbd69d16
    <!-- Bottom Navigation -->
    <nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 px-4 py-2">
        <div class="flex justify-around items-center max-w-md mx-auto">
            <a href="home.html" class="flex flex-col items-center text-xs text-gray-600 hover:text-primary p-2 transition-colors">
                <svg class="w-5 h-5 mb-1" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"/>
                </svg>
                Home
            </a>
            <a href="../convenzioni.html" class="flex flex-col items-center text-xs text-gray-600 hover:text-primary p-2 transition-colors">
                <svg class="w-5 h-5 mb-1" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M4 4a2 2 0 00-2 2v1h16V6a2 2 0 00-2-2H4zM18 9H2v5a2 2 0 002 2h12a2 2 0 002-2V9zM4 13a1 1 0 011-1h1a1 1 0 110 2H5a1 1 0 01-1-1zm5-1a1 1 0 100 2h1a1 1 0 100-2H9z"/>
                </svg>
                Convenzioni
            </a>
            <a href="tessera.html" class="flex flex-col items-center text-xs text-gray-600 hover:text-primary p-2 transition-colors">
                <svg class="w-5 h-5 mb-1" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"/>
                </svg>
                Tessera
            </a>
            <a href="virgilio.html" class="flex flex-col items-center text-xs text-primary p-2">
                <svg class="w-5 h-5 mb-1" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.338-3.123C2.493 12.767 2 11.434 2 10c0-3.866 3.582-7 8-7s8 3.134 8 7zM7 9H5v2h2V9zm8 0h-2v2h2V9zM9 9h2v2H9V9z" clip-rule="evenodd"/>
                </svg>
                Virgilio
            </a>
            <a href="profilo.html" class="flex flex-col items-center text-xs text-gray-600 hover:text-primary p-2 transition-colors">
                <svg class="w-5 h-5 mb-1" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.533 1.533 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.533 1.533 0 01.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd"/>
                </svg>
                Profilo
            </a>
        </div>
    </nav>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

        // Configurazione Supabase
        const supabaseUrl = 'https://lycrgzptkdkksukcwrld.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx5Y3JnenB0a2Rra3N1a2N3cmxkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI3ODQyMzAsImV4cCI6MjA2ODM2MDIzMH0.ZJGOXAMC3hKKrnwXHKEa2_Eh7ZpOKeLYvYlYneBiEfk';
        const supabase = createClient(supabaseUrl, supabaseKey);

<<<<<<< HEAD
        // Configurazione ChatBot - AGGIORNA QUESTO URL!
        const CHATBOT_CONFIG = {
            // PER TEST LOCALE: 'http://localhost:3001/api/chat'
            // PER PRODUZIONE: https://myapp2026.onrender.com
            const CHATBOT_CONFIG = {
    apiEndpoint: 'https://myapp-chatbot-server-xxx.onrender.com/api/chat', // https://myapp2026.onrender.com
            maxTokens: 500,
            temperature: 0.7,
            model: 'gpt-4o-mini', // Più economico di gpt-4
            maxHistory: 8,
            retryAttempts: 3,
            retryDelay: 1000
=======
        // 🔧 CONFIGURAZIONE CHATBOT POTENZIATA
        const CHATBOT_CONFIG = {
            apiEndpoint: 'https://myapp-chatbot-server.onrender.com/api/chat',
            apiEndpointLocal: 'http://localhost:3001/api/chat',
            maxTokens: 400,
            temperature: 0.7,
            model: 'gpt-4o-mini',
            maxHistory: 8,
            retryAttempts: 3,
            retryDelay: 1000,
            enableWebSearch: true,
            webSearchThreshold: 0.3
>>>>>>> d1411ea201200f1b013f73c51a7ac06efbd69d16
        };

        // Variabili globali
        let currentUser = null;
        let conversationHistory = [];
        let isProcessing = false;
        let totalTokensUsed = 0;
<<<<<<< HEAD
        let retryCount = 0;

        // Funzioni di utilità
        function showLoading() {
            document.getElementById('loading').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loading').classList.add('hidden');
        }

        function showError(message, isRetryable = false) {
            const errorDiv = document.getElementById('errorMessage');
            const errorText = document.getElementById('errorText');
            
            errorText.textContent = message;
            errorDiv.classList.remove('hidden');
            
            setTimeout(() => {
                errorDiv.classList.add('hidden');
            }, 5000);
            
            setConnectionStatus(false);
        }

        function hideError() {
            document.getElementById('errorMessage').classList.add('hidden');
        }

        function showSuccess(message) {
            const successDiv = document.getElementById('successMessage');
            const successText = document.getElementById('successText');
            
            successText.textContent = message;
            successDiv.classList.remove('hidden');
            
            setTimeout(() => {
                successDiv.classList.add('hidden');
            }, 3000);
        }

        function setConnectionStatus(connected) {
            const status = document.getElementById('connectionStatus');
            if (connected) {
                status.className = 'w-3 h-3 bg-green-500 rounded-full connection-dot';
                status.title = 'Connesso';
            } else {
                status.className = 'w-3 h-3 bg-red-500 rounded-full';
                status.title = 'Disconnesso';
            }
        }

        // Auth check
        async function verificaAutenticazione() {
            try {
                const { data: { user }, error } = await supabase.auth.getUser();
                
                if (error || !user) {
                    window.location.href = '../login.html';
                    return null;
                }
                
                return user;
            } catch (error) {
                console.error('Errore autenticazione:', error);
                window.location.href = '../login.html';
                return null;
            }
        }

        // Logout
        async function logout() {
            if (confirm('Sei sicuro di voler uscire?')) {
                try {
                    await supabase.auth.signOut();
                    window.location.href = '../login.html';
                } catch (error) {
                    console.error('Errore durante il logout:', error);
                    window.location.href = '../login.html';
                }
            }
        }

        // Chat functions
        function formatTime() {
            return new Date().toLocaleTimeString('it-IT', {
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function addMessage(message, isUser = false) {
            const chatMessages = document.getElementById('chatMessages');
=======
        let dirigenti = [];
        let conversationContext = {
            askingForDirigenti: false,
            waitingForLevel: false,
            waitingForProvince: false,
            currentLevel: null
        };

        // --- FUNZIONI DI UTILITÀ ---
        
        function addMessage(content, type = 'bot', timestamp = new Date(), hasWebSearch = false) {
            const messagesContainer = document.getElementById('chatMessages');
>>>>>>> d1411ea201200f1b013f73c51a7ac06efbd69d16
            const messageDiv = document.createElement('div');
            messageDiv.className = 'flex items-start space-x-3 animate-fade-in';
            
            let webSearchBadge = '';
            if (hasWebSearch && type === 'bot') {
                webSearchBadge = '<div class="web-search-indicator">🌐 Ricerca Web</div>';
            }
            
            if (type === 'user') {
                messageDiv.innerHTML = `
<<<<<<< HEAD
                    <div class="flex items-start space-x-3 justify-end">
                        <div class="message-user rounded-2xl p-4 max-w-xs text-white">
                            <p class="text-sm">${escapeHtml(message)}</p>
                            <span class="text-xs opacity-75 mt-2 block">${formatTime()}</span>
                        </div>
                        <div class="w-8 h-8 bg-white rounded-full flex items-center justify-center flex-shrink-0">
                            <span class="text-primary text-sm">👤</span>
                        </div>
=======
                    <div class="flex-1"></div>
                    <div class="message-user rounded-2xl p-4 max-w-sm">
                        <div class="text-white text-base leading-relaxed">${content}</div>
                        <div class="text-xs text-gray-200 mt-2 opacity-75">${timestamp.toLocaleTimeString('it-IT', {hour: '2-digit', minute: '2-digit'})}</div>
                    </div>
                    <div class="w-8 h-8 bg-primary rounded-full flex items-center justify-center">
                        <span class="text-white text-sm">👤</span>
                    </div>
                `;
            } else if (type === 'system') {
                messageDiv.innerHTML = `
                    <div class="w-8 h-8 bg-accent rounded-full flex items-center justify-center">
                        <span class="text-white text-sm">ℹ️</span>
                    </div>
                    <div class="message-system rounded-2xl p-4 max-w-sm w-full">
                        <div class="text-white text-base leading-relaxed">${content}</div>
>>>>>>> d1411ea201200f1b013f73c51a7ac06efbd69d16
                    </div>
                `;
            } else {
                messageDiv.innerHTML = `
<<<<<<< HEAD
                    <div class="flex items-start space-x-3">
                        <div class="w-8 h-8 bg-accent rounded-full flex items-center justify-center flex-shrink-0">
                            <span class="text-white text-sm">🤖</span>
                        </div>
                        <div class="message-bot rounded-2xl p-4 max-w-xs">
                            <div class="text-textDark text-sm markdown-content">${formatMessage(message)}</div>
                            <span class="text-xs text-gray-500 mt-2 block">${formatTime()}</span>
                        </div>
=======
                    <div class="w-8 h-8 bg-accent rounded-full flex items-center justify-center">
                        <span class="text-white text-sm">🤖</span>
                    </div>
                    <div class="message-bot rounded-2xl p-4 max-w-sm">
                        ${webSearchBadge}
                        <div class="text-textDark text-base leading-relaxed">${content}</div>
                        <div class="text-xs text-gray-500 mt-2">${timestamp.toLocaleTimeString('it-IT', {hour: '2-digit', minute: '2-digit'})}</div>
>>>>>>> d1411ea201200f1b013f73c51a7ac06efbd69d16
                    </div>
                `;
            }
            
            messagesContainer.appendChild(messageDiv);
            
            // Scroll automatico con ritardo
            setTimeout(() => {
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }, 100);
        }

        async function loadDirigenti() {
            try {
                const { data, error } = await supabase
                    .from('organico_dirigentisindacali')
                    .select('*')
                    .order('id', { ascending: true });
                
                if (error) throw error;
                
                dirigenti = data || [];
                console.log('✅ Dirigenti caricati:', dirigenti.length);
                
            } catch (error) {
                console.error('❌ Errore caricamento dirigenti:', error);
                dirigenti = [
                    {
                        nome_cognome: 'Antonio Grande',
                        ruolo: 'Segretario Generale Regionale - Veneto',
                        email: 'veneto@carabinierinsic.it',
                        telefono: '3351470886'
                    },
                    {
                        nome_cognome: 'Andrea Modolo',
                        ruolo: 'Segretario Generale Regionale Vicario - Veneto',
                        email: 'veneto@carabinierinsic.it',
                        telefono: '3770969168'
                    }
                ];
            }
        }

        async function searchDirigentiByLevel(level) {
            try {
                let query = supabase.from('organico_dirigentisindacali').select('*');
                
                if (level === 'regionale') {
                    query = query.ilike('ruolo', '%Regionale%');
                } else if (level === 'provinciale') {
                    query = query.ilike('ruolo', '%Provinciale%');
                }
                
                const { data, error } = await query.order('id', { ascending: true });
                
                if (error) throw error;
                return data || [];
                
            } catch (error) {
                console.error('❌ Errore ricerca dirigenti per livello:', error);
                return [];
            }
        }

        async function searchDirigentiByProvince(province) {
            try {
                const { data, error } = await supabase
                    .from('organico_dirigentisindacali')
                    .select('*')
                    .ilike('ruolo', `%${province}%`)
                    .order('id', { ascending: true });
                
                if (error) throw error;
                return data || [];
                
            } catch (error) {
                console.error('❌ Errore ricerca dirigenti per provincia:', error);
                return [];
            }
        }

        function formatDirigentiList(dirigentiList, title) {
            if (!dirigentiList || dirigentiList.length === 0) {
                return `<strong>${title}</strong><br><br>❌ Nessun dirigente trovato per questa ricerca.`;
            }

            let result = `<strong>${title}</strong><br><br>`;
            dirigentiList.forEach((dirigente, index) => {
                result += `<strong>${index + 1}. ${dirigente.nome_cognome}</strong><br>`;
                result += `📋 <em>${dirigente.ruolo}</em><br>`;
                if (dirigente.email) {
                    result += `📧 <a href="mailto:${dirigente.email}" class="text-primary underline">${dirigente.email}</a><br>`;
                }
                if (dirigente.telefono) {
                    result += `📞 <a href="tel:${dirigente.telefono}" class="text-primary underline">${dirigente.telefono}</a><br>`;
                }
                result += '<br>';
            });
            
            return result;
        }

        // Funzione per gestire logica dirigenti - CORRETTA
        function handleDirigentiQuery(message) {
            const messageLower = message.toLowerCase();
            
            // Reset context se cambia argomento completamente
            if (!messageLower.includes('dirigent') && !messageLower.includes('regionale') && 
                !messageLower.includes('provinciale') && !conversationContext.askingForDirigenti && 
                !conversationContext.waitingForLevel && !conversationContext.waitingForProvince) {
                conversationContext = {
                    askingForDirigenti: false,
                    waitingForLevel: false,
                    waitingForProvince: false,
                    currentLevel: null
                };
                return null;
            }
            
            // 1. Prima richiesta dirigenti
            if ((messageLower.includes('dirigent') && messageLower.includes('sindacali')) || 
                messageLower.includes('chi sono i dirigenti') || 
                messageLower.includes('contatti dirigenti')) {
                
                conversationContext.askingForDirigenti = true;
                conversationContext.waitingForLevel = true;
                return {
                    type: 'ask_level',
                    message: `Vuoi i contatti dei dirigenti sindacali a livello <strong>Regionale</strong> o <strong>Provinciale</strong>?<br><br>Scrivi semplicemente "regionale" o "provinciale".`
                };
            }
            
            // 2. Risposta livello
            if (conversationContext.waitingForLevel) {
                if (messageLower.includes('regionale')) {
                    conversationContext.waitingForLevel = false;
                    conversationContext.currentLevel = 'regionale';
                    return { type: 'search_regional' };
                } else if (messageLower.includes('provinciale')) {
                    conversationContext.waitingForLevel = false;
                    conversationContext.waitingForProvince = true;
                    conversationContext.currentLevel = 'provinciale';
                    return {
                        type: 'ask_province',
                        message: `Di quale <strong>provincia</strong> hai bisogno?<br><br>Esempi: Verona, Padova, Venezia, Vicenza, Treviso, Belluno, Rovigo...`
                    };
                } else {
                    // Se non riconosce la risposta, ripeti la domanda
                    return {
                        type: 'ask_level',
                        message: `Non ho capito. Vuoi i contatti dei dirigenti sindacali a livello <strong>Regionale</strong> o <strong>Provinciale</strong>?<br><br>Scrivi "regionale" o "provinciale".`
                    };
                }
            }
            
            // 3. Risposta provincia
            if (conversationContext.waitingForProvince) {
                const province = ['verona', 'padova', 'venezia', 'vicenza', 'treviso', 'belluno', 'rovigo', 'veneto'];
                const foundProvince = province.find(p => messageLower.includes(p));
                
                if (foundProvince) {
                    conversationContext.waitingForProvince = false;
                    conversationContext.askingForDirigenti = false;
                    return { 
                        type: 'search_province',
                        province: foundProvince.charAt(0).toUpperCase() + foundProvince.slice(1)
                    };
                } else {
                    // Se non riconosce la provincia, ripeti la domanda
                    return {
                        type: 'ask_province',
                        message: `Non ho trovato quella provincia. Di quale <strong>provincia del Veneto</strong> hai bisogno?<br><br>Esempi: Verona, Padova, Venezia, Vicenza, Treviso, Belluno, Rovigo...`
                    };
                }
            }
            
            return null;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatMessage(text) {
            return escapeHtml(text)
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/\n/g, '<br>');
        }

        function showTyping() {
            document.getElementById('typingIndicator').classList.remove('hidden');
<<<<<<< HEAD
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.scrollTop = chatMessages.scrollHeight;
=======
            const container = document.getElementById('chatMessages');
            setTimeout(() => {
                container.scrollTop = container.scrollHeight;
            }, 150);
>>>>>>> d1411ea201200f1b013f73c51a7ac06efbd69d16
        }

        function hideTyping() {
            document.getElementById('typingIndicator').classList.add('hidden');
        }

<<<<<<< HEAD
        // Funzione principale per chiamare l'API
        async function callChatAPI(messages, attempt = 1) {
            const { data: { session } } = await supabase.auth.getSession();
            
            if (!session) {
                throw new Error('Sessione scaduta');
            }

            const response = await fetch(CHATBOT_CONFIG.apiEndpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${session.access_token}`
                },
                body: JSON.stringify({
                    messages: messages,
                    model: CHATBOT_CONFIG.model,
                    max_tokens: CHATBOT_CONFIG.maxTokens,
                    temperature: CHATBOT_CONFIG.temperature
                })
            });

            if (!response.ok) {
                const errorData = await response.json();
                
                if (response.status === 429 && attempt < CHATBOT_CONFIG.retryAttempts) {
                    await new Promise(resolve => 
                        setTimeout(resolve, CHATBOT_CONFIG.retryDelay * attempt)
                    );
                    return callChatAPI(messages, attempt + 1);
                }
                
                throw new Error(errorData.error || `Errore HTTP ${response.status}`);
            }

            return response.json();
=======
        function updateSendButton() {
            const input = document.getElementById('messageInput');
            const button = document.getElementById('sendMessage');
            const hasText = input.value.trim().length > 0;
            
            button.disabled = !hasText || isProcessing;
            button.style.opacity = button.disabled ? '0.5' : '1';
        }

        function updateCharCount() {
            const input = document.getElementById('messageInput');
            const counter = document.getElementById('charCount');
            counter.textContent = input.value.length;
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.querySelector('p').textContent = `⚠️ ${message}`;
            errorDiv.classList.remove('hidden');
            setTimeout(() => errorDiv.classList.add('hidden'), 5000);
        }

        function showSuccess(message) {
            const successDiv = document.getElementById('successMessage');
            successDiv.querySelector('p').textContent = `✅ ${message}`;
            successDiv.classList.remove('hidden');
            setTimeout(() => successDiv.classList.add('hidden'), 3000);
        }

        function updateConnectionStatus(isConnected) {
            const status = document.getElementById('connectionStatus');
            if (isConnected) {
                status.className = 'w-3 h-3 bg-green-500 rounded-full';
                status.title = 'Connesso';
            } else {
                status.className = 'w-3 h-3 bg-red-500 rounded-full';
                status.title = 'Disconnesso';
            }
        }

        function getApiEndpoint() {
            if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                console.log('🔧 Usando server locale per sviluppo');
                return CHATBOT_CONFIG.apiEndpointLocal;
            }
            
            console.log('🚀 Usando server chatbot Render:', CHATBOT_CONFIG.apiEndpoint);
            return CHATBOT_CONFIG.apiEndpoint;
        }

        // Inizializza la chat con messaggio di benvenuto aggiornato
        function initializeChat() {
            const messagesContainer = document.getElementById('chatMessages');
            messagesContainer.innerHTML = '';

            // Reset conversation context
            conversationContext = {
                askingForDirigenti: false,
                waitingForLevel: false,
                waitingForProvince: false,
                currentLevel: null
            };

            // Messaggio di benvenuto con info sui dirigenti
            setTimeout(() => {
                addMessage(`Ciao! Sono <strong>Virgilio</strong> 🤖, il tuo assistente sindacale AI.
                <br><br>
                Sono qui per aiutarti con informazioni su:
                <br>• Contratti e stipendi 📋
                <br>• Ferie e permessi 🏖️  
                <br>• Diritti sindacali ⚖️
                <br>• Procedure e normative 📝
                <br>• <strong>Contatti dirigenti sindacali</strong> 👥
                <br><br>
                <strong>Scrivi la tua domanda nell'area qui sotto!</strong>
                <br><br>
                💡 <em>Prova a scrivere: "Chi sono i dirigenti sindacali?"</em>`, 'bot');
            }, 500);
        }

        // Funzione per decidere se necessita ricerca web
        function needsWebSearch(message) {
            const webSearchKeywords = [
                'ultime notizie', 'news', 'aggiornamenti', 'recenti', 'oggi', 
                'attuale', 'corrente', 'nuovo', 'ultima', 'current',
                'stipendio 2025', 'contratto 2025', 'aumenti', 'novità',
                'legge', 'decreto', 'normativa', 'giurisprudenza',
                'confronta', 'vs', 'statistiche', 'dati', 'cifre',
                'cosa dice', 'secondo', 'fonte', 'verifica'
            ];
            
            const messageLower = message.toLowerCase();
            return webSearchKeywords.some(keyword => messageLower.includes(keyword));
>>>>>>> d1411ea201200f1b013f73c51a7ac06efbd69d16
        }

        // Invio messaggio
        async function sendMessage() {
<<<<<<< HEAD
            if (isProcessing) return;
            
            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();
            
            if (!message) return;

            isProcessing = true;
            hideError();

            // Aggiungi messaggio utente
            addMessage(message, true);
            messageInput.value = '';
            updateSendButton();
            updateCharCount();

            // Mostra typing
            showTyping();

            try {
                // Prepara cronologia messaggi
                const messages = conversationHistory
                    .slice(-CHATBOT_CONFIG.maxHistory)
                    .map(msg => ({
                        role: msg.role,
                        content: msg.content
                    }));
                
                messages.push({ role: 'user', content: message });

                // Salva messaggio utente
                conversationHistory.push({
                    role: 'user',
                    content: message,
                    timestamp: new Date()
                });

                // Chiamata API
                const response = await callChatAPI(messages);

                // Nascondi typing e mostra risposta
                hideTyping();
                const botMessage = response.choices[0].message.content;
                addMessage(botMessage);

                // Salva risposta
                conversationHistory.push({
                    role: 'assistant',
                    content: botMessage,
                    timestamp: new Date()
=======
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message || isProcessing) return;
            
            isProcessing = true;
            updateSendButton();
            
            // Aggiungi messaggio utente
            addMessage(message, 'user');
            conversationHistory.push({ role: 'user', content: message });
            
            // Pulisci input
            input.value = '';
            updateCharCount();
            updateSendButton();
            
            // **GESTIONE DIRIGENTI - QUI È LA PARTE PRINCIPALE CHE MANCAVA**
            const dirigentiAction = handleDirigentiQuery(message);
            
            if (dirigentiAction) {
                hideTyping();
                
                try {
                    if (dirigentiAction.type === 'ask_level' || dirigentiAction.type === 'ask_province') {
                        // Mostra domanda di follow-up
                        setTimeout(() => {
                            addMessage(dirigentiAction.message, 'bot');
                            conversationHistory.push({ role: 'assistant', content: dirigentiAction.message });
                        }, 800);
                        
                    } else if (dirigentiAction.type === 'search_regional') {
                        // Cerca dirigenti regionali
                        showTyping();
                        const dirigentiRegionali = await searchDirigentiByLevel('regionale');
                        hideTyping();
                        
                        const responseMessage = formatDirigentiList(dirigentiRegionali, '📋 Dirigenti Sindacali Regionali');
                        setTimeout(() => {
                            addMessage(responseMessage, 'bot');
                            conversationHistory.push({ role: 'assistant', content: responseMessage });
                        }, 800);
                        
                    } else if (dirigentiAction.type === 'search_province') {
                        // Cerca dirigenti provinciali
                        showTyping();
                        const dirigentiProvinciali = await searchDirigentiByProvince(dirigentiAction.province);
                        hideTyping();
                        
                        const responseMessage = formatDirigentiList(dirigentiProvinciali, `📋 Dirigenti Sindacali - ${dirigentiAction.province}`);
                        setTimeout(() => {
                            addMessage(responseMessage, 'bot');
                            conversationHistory.push({ role: 'assistant', content: responseMessage });
                        }, 800);
                    }
                    
                } catch (error) {
                    console.error('❌ Errore gestione dirigenti:', error);
                    hideTyping();
                    showError('Errore nel recupero dei contatti dirigenti');
                }
                
                isProcessing = false;
                updateSendButton();
                input.focus();
                return;
            }
            
            // **GESTIONE NORMALE CHATBOT (se non è una query sui dirigenti)**
            
            // Mostra typing indicator
            showTyping();
            
            // Determina se serve ricerca web
            const requiresWebSearch = needsWebSearch(message);
            
            try {
                // Ottieni token di autenticazione
                const { data: { session } } = await supabase.auth.getSession();
                if (!session) {
                    throw new Error('Sessione scaduta');
                }

                // Determina endpoint API
                const apiEndpoint = getApiEndpoint();
                
                console.log('📡 Richiesta inviata:', {
                    enable_web_search: requiresWebSearch,
                    web_search_query: requiresWebSearch ? message : null,
                    model: CHATBOT_CONFIG.model,
                    messages_count: conversationHistory.slice(-CHATBOT_CONFIG.maxHistory).length
>>>>>>> d1411ea201200f1b013f73c51a7ac06efbd69d16
                });
                
                if (requiresWebSearch) {
                    console.log('🌐 Richiesta ricerca web abilitata per:', message);
                }

<<<<<<< HEAD
                // Aggiorna contatore token
                if (response.usage) {
                    totalTokensUsed += response.usage.total_tokens;
                    updateTokenCount();
                }

                // Salva conversazione nel database
                await salvaConversazione(message, botMessage);

                setConnectionStatus(true);
                retryCount = 0;
=======
                // Crea prompt potenziato con info sui dirigenti
                let systemContext = `Sei Virgilio, assistente AI del Sindacato Carabinieri. Rispondi in modo conciso e utile.`;
                
                if (dirigenti.length > 0) {
                    systemContext += `\n\nCONTATTI DIRIGENTI SINDACATO:\n`;
                    dirigenti.forEach(dirigente => {
                        systemContext += `- ${dirigente.nome_cognome} (${dirigente.ruolo})`;
                        if (dirigente.email) systemContext += ` - ${dirigente.email}`;
                        if (dirigente.telefono) systemContext += ` - ${dirigente.telefono}`;
                        systemContext += '\n';
                    });
                }

                // Prepara richiesta con supporto ricerca web
                const requestBody = {
                    messages: conversationHistory.slice(-CHATBOT_CONFIG.maxHistory),
                    model: CHATBOT_CONFIG.model,
                    max_tokens: CHATBOT_CONFIG.maxTokens,
                    temperature: CHATBOT_CONFIG.temperature,
                    system_context: systemContext,
                    enable_web_search: requiresWebSearch,
                    web_search_query: requiresWebSearch ? message : null
                };

                // Chiamata API con retry
                let lastError = null;
                for (let attempt = 0; attempt < CHATBOT_CONFIG.retryAttempts; attempt++) {
                    try {
                        const response = await fetch(apiEndpoint, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${session.access_token}`
                            },
                            body: JSON.stringify(requestBody)
                        });

                        if (!response.ok) {
                            const errorData = await response.json().catch(() => ({}));
                            throw new Error(errorData.error || `HTTP ${response.status}`);
                        }

                        const data = await response.json();
                        
                        if (!data.choices || !data.choices[0] || !data.choices[0].message) {
                            throw new Error('Risposta API non valida');
                        }

                        const botResponse = data.choices[0].message.content;
                        const hasWebSearch = data.web_search_performed || false;
                        
                        // Aggiungi risposta del bot con indicatore ricerca web
                        addMessage(botResponse, 'bot', new Date(), hasWebSearch);
                        conversationHistory.push({ role: 'assistant', content: botResponse });
                        
                        // Aggiorna contatori
                        if (data.usage) {
                            totalTokensUsed += data.usage.total_tokens || 0;
                            document.getElementById('tokenCount').textContent = totalTokensUsed;
                        }

                        // Log dettagli ricerca web
                        if (hasWebSearch) {
                            console.log('🌐 Ricerca web eseguita:', data.web_search_results || 'Risultati integrati');
                        } else if (requiresWebSearch) {
                            console.warn('⚠️ Ricerca web richiesta ma non eseguita dal server');
                        }

                        updateConnectionStatus(true);
                        console.log('✅ Messaggio inviato con successo');
                        break;
                        
                    } catch (error) {
                        lastError = error;
                        console.warn(`⚠️ Tentativo ${attempt + 1} fallito:`, error.message);
                        
                        if (attempt < CHATBOT_CONFIG.retryAttempts - 1) {
                            await new Promise(r => setTimeout(r, CHATBOT_CONFIG.retryDelay * (attempt + 1)));
                        }
                    }
                }

                if (lastError) {
                    throw lastError;
                }
>>>>>>> d1411ea201200f1b013f73c51a7ac06efbd69d16

            } catch (error) {
                console.error('❌ Errore invio messaggio:', error);
                
                // Rimuovi ultimo messaggio utente dalla cronologia
                conversationHistory.pop();
                
                // Mostra errore specifico
                let errorMessage = 'Errore di connessione';
                if (error.message.includes('scadut')) {
                    errorMessage = 'Sessione scaduta, riaccedi';
                } else if (error.message.includes('network') || error.message.includes('fetch')) {
                    errorMessage = 'Problema di rete, riprova';
                } else if (error.message.includes('500')) {
                    errorMessage = 'Servizio temporaneamente non disponibile';
                } else if (error.message.includes('401')) {
                    errorMessage = 'Autenticazione non valida';
                } else if (error.message.includes('404')) {
                    errorMessage = 'Server chatbot non trovato';
                }
                
                showError(errorMessage);
                updateConnectionStatus(false);
                
            } finally {
                hideTyping();
<<<<<<< HEAD
                console.error('Errore chat:', error);

                let errorMessage = 'Si è verificato un errore. Riprova tra poco.';
                
                if (error.message.includes('Sessione scaduta')) {
                    errorMessage = 'Sessione scaduta. Effettua nuovamente il login.';
                    setTimeout(() => {
                        window.location.href = '../login.html';
                    }, 2000);
                } else if (error.message.includes('429')) {
                    errorMessage = 'Troppi messaggi inviati. Attendi un momento prima di riprovare.';
                } else if (error.message.includes('AI non configurato')) {
                    errorMessage = 'Servizio AI temporaneamente non disponibile. Contatta il supporto.';
                } else if (error.message.includes('Troppi messaggi')) {
                    errorMessage = 'Hai raggiunto il limite di messaggi. Riprova tra 15 minuti.';
                }

                addMessage(`⚠️ ${errorMessage}`, false);
                showError(errorMessage);
            } finally {
                isProcessing = false;
            }
        }

        // Salva conversazione nel database
        async function salvaConversazione(userMessage, botResponse) {
            if (!currentUser) return;

            try {
                const { error } = await supabase.from('chat_messages').insert([
                    {
                        user_id: currentUser.id,
                        user_message: userMessage,
                        bot_response: botResponse,
                        created_at: new Date().toISOString()
                    }
                ]);

                if (error) {
                    console.error('Errore salvataggio:', error);
                }
            } catch (error) {
                console.error('Errore salvataggio conversazione:', error);
            }
        }

        // Carica cronologia conversazioni
        async function caricaCronologia() {
            if (!currentUser) return;

            try {
                const { data, error } = await supabase
                    .from('chat_messages')
                    .select('user_message, bot_response, created_at')
                    .eq('user_id', currentUser.id)
                    .order('created_at', { ascending: true })
                    .limit(CHATBOT_CONFIG.maxHistory * 2);

                if (error) {
                    console.error('Errore caricamento cronologia:', error);
                    return;
                }

                // Ricostruisci la cronologia (escludi il messaggio di benvenuto)
                conversationHistory = [];
                data.forEach(row => {
                    conversationHistory.push(
                        { role: 'user', content: row.user_message, timestamp: new Date(row.created_at) },
                        { role: 'assistant', content: row.bot_response, timestamp: new Date(row.created_at) }
                    );
                });

                // Mostra gli ultimi messaggi nella UI (max 6)
                const recentMessages = data.slice(-3);
                if (recentMessages.length > 0) {
                    // Rimuovi messaggio di benvenuto se ci sono messaggi precedenti
                    const welcomeMsg = document.getElementById('welcomeMessage');
                    if (welcomeMsg) welcomeMsg.remove();

                    recentMessages.forEach(row => {
                        addMessage(row.user_message, true);
                        addMessage(row.bot_response, false);
                    });
                }

            } catch (error) {
                console.error('Errore caricamento cronologia:', error);
            }
        }

        // Pulisci chat
        async function clearChat() {
            if (confirm('Sei sicuro di voler cancellare tutta la cronologia chat?')) {
                try {
                    // Cancella dal database
                    const { error } = await supabase
                        .from('chat_messages')
                        .delete()
                        .eq('user_id', currentUser.id);

                    if (error) {
                        console.error('Errore cancellazione:', error);
                        showError('Errore durante la cancellazione della chat');
                        return;
                    }

                    // Pulisci la UI
                    const chatMessages = document.getElementById('chatMessages');
                    chatMessages.innerHTML = `
                        <div class="flex items-start space-x-3" id="welcomeMessage">
                            <div class="w-8 h-8 bg-accent rounded-full flex items-center justify-center flex-shrink-0">
                                <span class="text-white text-sm">🤖</span>
                            </div>
                            <div class="message-bot rounded-2xl p-4 max-w-xs">
                                <div class="text-textDark text-sm markdown-content">Chat pulita! Come posso aiutarti oggi?</div>
                                <span class="text-xs text-gray-500 mt-2 block">${formatTime()}</span>
                            </div>
                        </div>
                    `;

                    // Reset variabili
                    conversationHistory = [];
                    totalTokensUsed = 0;
                    updateTokenCount();

                    showSuccess('Chat pulita con successo!');

                } catch (error) {
                    console.error('Errore pulizia chat:', error);
                    showError('Errore durante la pulizia della chat');
                }
            }
        }

        // Update UI functions
        function updateSendButton() {
            const messageInput = document.getElementById('messageInput');
            const sendButton = document.getElementById('sendMessage');
            
            if (messageInput.value.trim() && !isProcessing) {
                sendButton.disabled = false;
                sendButton.classList.remove('opacity-50');
            } else {
                sendButton.disabled = true;
                sendButton.classList.add('opacity-50');
            }
        }

        function updateCharCount() {
            const messageInput = document.getElementById('messageInput');
            const charCount = document.getElementById('charCount');
            const currentLength = messageInput.value.length;
            
            charCount.textContent = currentLength;
            
            if (currentLength > 400) {
                charCount.classList.add('text-red-500');
            } else {
                charCount.classList.remove('text-red-500');
            }
        }

        function updateTokenCount() {
            const tokenCountElement = document.getElementById('tokenCount');
            tokenCountElement.textContent = totalTokensUsed.toLocaleString();
        }

        // Quick replies
        function setupQuickReplies() {
            const quickReplies = document.querySelectorAll('.quick-reply');
            
            quickReplies.forEach(button => {
                button.addEventListener('click', () => {
                    const message = button.getAttribute('data-message');
                    if (message && !isProcessing) {
                        document.getElementById('messageInput').value = message;
                        updateSendButton();
                        updateCharCount();
                        // Auto-send quick replies
                        setTimeout(() => sendMessage(), 200);
                    }
                });
=======
                isProcessing = false;
                updateSendButton();
                input.focus();
            }
        }

        async function verificaAutenticazione() {
            try {
                const { data: { session } } = await supabase.auth.getSession();
                
                if (!session) {
                    console.log('❌ Nessuna sessione attiva');
                    window.location.href = '../login.html';
                    return null;
                }

                console.log('✅ Utente autenticato:', session.user.email);
                return session.user;
                
            } catch (error) {
                console.error('❌ Errore verifica auth:', error);
                window.location.href = '../login.html';
                return null;
            }
        }

        async function testApiConnection() {
            try {
                const { data: { session } } = await supabase.auth.getSession();
                if (!session) return;

                const healthEndpoint = 'https://myapp-chatbot-server.onrender.com/api/health';
                
                console.log('🔍 Testando connessione API:', healthEndpoint);
                
                const response = await fetch(healthEndpoint, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${session.access_token}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    console.log('✅ Server chatbot raggiungibile:', data);
                    updateConnectionStatus(true);
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
                
            } catch (error) {
                console.warn('⚠️ Test connessione API fallito:', error.message);
                updateConnectionStatus(false);
                
                setTimeout(() => {
                    showError('Server chatbot non raggiungibile. Il servizio potrebbe essere in fase di avvio...');
                }, 2000);
            }
        }

        // Event Listeners
        document.addEventListener('DOMContentLoaded', async () => {
            // Verifica autenticazione
            currentUser = await verificaAutenticazione();
            if (!currentUser) return;

            // Carica dirigenti
            await loadDirigenti();

            // Inizializza chat
            initializeChat();

            const input = document.getElementById('messageInput');
            const sendButton = document.getElementById('sendMessage');

            // Event listeners per input
            input.addEventListener('input', () => {
                updateCharCount();
                updateSendButton();
>>>>>>> d1411ea201200f1b013f73c51a7ac06efbd69d16
            });

<<<<<<< HEAD
        // Help function
        window.showHelp = function() {
            const helpMessage = `🆘 **Assistenza Immediata**

Per emergenze o questioni urgenti:

📞 **Telefono**: 06-123456789
📧 **Email**: assistenza@simcarabinieri.it
🏢 **Sede**: Via Roma 123, Roma

**Orari di ricevimento**:
• Lunedì-Venerdì: 9:00-17:00
• Sabato: 9:00-12:00

Per assistenza tecnica con l'app, contatta il supporto IT.

**Comandi disponibili**:
• Usa le domande frequenti per risposte rapide
• Digita "aiuto" per questa guida
• Clicca 🗑️ per pulire la chat`;

            addMessage(helpMessage, false);
        };

        // Gestione della connessione
        function monitorConnection() {
            setInterval(async () => {
                try {
                    const healthUrl = CHATBOT_CONFIG.apiEndpoint.replace('/chat', '/health');
                    const response = await fetch(healthUrl, { 
                        method: 'GET',
                        cache: 'no-cache' 
                    });
                    setConnectionStatus(response.ok);
                } catch {
                    setConnectionStatus(false);
                }
            }, 30000); // Check ogni 30 secondi
        }

        // Gestione comandi speciali
        function handleSpecialCommands(message) {
            const lowerMessage = message.toLowerCase().trim();
            
            if (lowerMessage === 'aiuto' || lowerMessage === 'help') {
                showHelp();
                return true;
            }
            
            if (lowerMessage === 'pulisci' || lowerMessage === 'clear') {
                clearChat();
                return true;
            }
            
            if (lowerMessage === 'stato' || lowerMessage === 'status') {
                const statusMessage = `📊 **Stato Sistema**

🔗 **Connessione**: ${document.getElementById('connectionStatus').classList.contains('bg-green-500') ? 'Attiva' : 'Disconnessa'}
🤖 **Modello AI**: ${CHATBOT_CONFIG.model}
📝 **Token utilizzati**: ${totalTokensUsed.toLocaleString()}
💬 **Messaggi nella cronologia**: ${conversationHistory.length / 2}
⏰ **Sessione attiva**: ${Math.floor((Date.now() - performance.timeOrigin) / 60000)} minuti

Il sistema è operativo e pronto ad assisterti.`;
                
                addMessage(statusMessage, false);
                return true;
            }
            
            return false;
        }

        // Event listeners
        document.getElementById('logoutBtn')?.addEventListener('click', logout);
        document.getElementById('clearChatBtn')?.addEventListener('click', clearChat);
        document.getElementById('sendMessage').addEventListener('click', sendMessage);

        document.getElementById('messageInput').addEventListener('input', () => {
            updateSendButton();
            updateCharCount();
        });

        document.getElementById('messageInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                
                const message = e.target.value.trim();
                
                // Controlla comandi speciali
                if (handleSpecialCommands(message)) {
                    e.target.value = '';
                    updateSendButton();
                    updateCharCount();
                    return;
                }
                
                sendMessage();
            }
        });

        // Gestione focus input quando si clicca in area chat
        document.getElementById('chatMessages').addEventListener('click', () => {
            if (!isProcessing) {
                document.getElementById('messageInput').focus();
            }
        });

        // Prevenzione perdita dati durante digitazione
        window.addEventListener('beforeunload', (e) => {
            const messageInput = document.getElementById('messageInput');
            if (messageInput.value.trim() && !isProcessing) {
                e.preventDefault();
                e.returnValue = 'Hai un messaggio non inviato. Sei sicuro di voler uscire?';
            }
        });

        // Service Worker per PWA
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js')
                .then(registration => {
                    console.log('SW registrato:', registration);
                })
                .catch(error => {
                    console.log('Errore SW:', error);
                });
        }

        // Notifiche push (se supportate)
        function setupNotifications() {
            if ('Notification' in window && 'serviceWorker' in navigator) {
                if (Notification.permission === 'default') {
                    // Richiedi permesso per le notifiche (opzionale)
                    // Notification.requestPermission();
                }
            }
        }

        // Gestione modalità offline
        window.addEventListener('online', () => {
            setConnectionStatus(true);
            showSuccess('Connessione ripristinata!');
        });

        window.addEventListener('offline', () => {
            setConnectionStatus(false);
            showError('Modalità offline. Alcune funzioni potrebbero non essere disponibili.');
        });

        // Inizializzazione
        document.addEventListener('DOMContentLoaded', async () => {
            showLoading();
            
            try {
                currentUser = await verificaAutenticazione();
                if (currentUser) {
                    await caricaCronologia();
                    setupQuickReplies();
                    setupNotifications();
                    monitorConnection();
                    setConnectionStatus(navigator.onLine);
                    
                    // Focus input dopo caricamento
                    setTimeout(() => {
                        document.getElementById('messageInput').focus();
                    }, 500);
                    
                    console.log('🤖 Virgilio inizializzato correttamente');
                    console.log(`📡 Endpoint API: ${CHATBOT_CONFIG.apiEndpoint}`);
                    console.log(`🧠 Modello: ${CHATBOT_CONFIG.model}`);
                }
            } catch (error) {
                console.error('Errore inizializzazione:', error);
                showError('Errore di inizializzazione. Ricarica la pagina.', false);
            } finally {
                hideLoading();
            }
        });

        // Debug globale (rimuovi in produzione)
        window.chatDebug = {
            config: CHATBOT_CONFIG,
            user: currentUser,
            history: conversationHistory,
            tokens: totalTokensUsed,
            clearChat: clearChat,
            testConnection: async () => {
                try {
                    const response = await fetch(CHATBOT_CONFIG.apiEndpoint.replace('/chat', '/health'));
                    console.log('Health check:', await response.json());
                } catch (error) {
                    console.error('Connection test failed:', error);
                }
            }
        };
=======
            input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            sendButton.addEventListener('click', sendMessage);

            // Clear chat
            document.getElementById('clearChatBtn').addEventListener('click', () => {
                if (confirm('Vuoi davvero cancellare tutta la conversazione?')) {
                    conversationHistory = [];
                    totalTokensUsed = 0;
                    document.getElementById('tokenCount').textContent = '0';
                    initializeChat();
                    showSuccess('Chat cancellata');
                }
            });

            // Logout
            document.getElementById('logoutBtn').addEventListener('click', async () => {
                if (confirm('Vuoi davvero disconnetterti?')) {
                    await supabase.auth.signOut();
                    window.location.href = '../login.html';
                }
            });

            // Focus sull'input
            input.focus();
            updateSendButton();

            // Test connessione API all'avvio
            testApiConnection();
        });

        // Gestione errori globali
        window.addEventListener('error', (event) => {
            console.error('❌ Errore JavaScript:', event.error);
            showError('Si è verificato un errore imprevisto');
        });

        window.addEventListener('unhandledrejection', (event) => {
            console.error('❌ Promise rejected:', event.reason);
            showError('Errore di rete o server');
        });

        // Gestione visibilità pagina
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden && currentUser) {
                testApiConnection();
            }
        });

        // Debug info
        console.log('🤖 Virgilio Chat con Dirigenti Sindacali inizializzata');
        console.log('🔧 Configurazione:', CHATBOT_CONFIG);
        console.log('🌐 Ricerca web abilitata:', CHATBOT_CONFIG.enableWebSearch);
        console.log('👥 Gestione dirigenti abilitata');
>>>>>>> d1411ea201200f1b013f73c51a7ac06efbd69d16
    </script>
</body>
</html>

