<a href="tessera.html" class="nav-item group flex flex-col items-center transition-all duration-300 hover:scale-110">
                <div class="p-2 rounded-xl bg-white/10 group-hover:bg-white/20 transition-all duration-300">
                    <svg class="w-6 h-6 mb-1 text-white group-hover:text-teal transition-colors" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"/>
                    </svg>
                </div>
                <span class="text-white font-bold text-xs group-hover:text-teal transition-colors">Tessera</span>
            </a>
            
            <a href="virgilio.html" class="nav-item group flex flex-col items-center transition-all duration-300 hover:scale-110">
                <div class="p-2 rounded-xl bg-aurora/20 group-hover:bg-aurora/30 transition-all duration-300 border border-aurora/40">
                    <svg class="w-6 h-6 mb-1 text-aurora group-hover:text-white transition-colors" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.338-3.123C2.493 12.767 2 11.434 2 10c0-3.866 3.582-7 8-7s8 3.134 8 7zM7 9H5v2h2V9zm8 0h-2v2h2V9zM9 9h2v2H9V9z" clip-rule="evenodd"/>
                    </svg>
                </div>
                <span class="text-aurora font-bold text-xs group-hover:text-white transition-colors">Virgilio</span>
            </a>
            
            <a href="profilo.html" class="nav-item group flex flex-col items-center transition-all duration-300 hover:scale-110">
                <div class="p-2 rounded-xl bg-white/10 group-hover:bg-white/20 transition-all duration-300">
                    <svg class="w-6 h-6 mb-1 text-white group-hover:text-gold transition-colors" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.533 1.533 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.533 1.533 0 01.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd"/>
                    </svg>
                </div>
                <span class="text-white font-bold text-xs group-hover:text-gold transition-colors">Profilo</span>
            </a>
        </div>
    </nav>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

        // Configurazione Supabase
        const supabaseUrl = 'https://lycrgzptkdkksukcwrld.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx5Y3JnenB0a2Rra3N1a2N3cmxkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI3ODQyMzAsImV4cCI6MjA2ODM2MDIzMH0.ZJGOXAMC3hKKrnwXHKEa2_Eh7ZpOKeLYvYlYneBiEfk';
        const supabase = createClient(supabaseUrl, supabaseKey);

        // 🔧 CONFIGURAZIONE CHATBOT AURORA POTENZIATA
        const CHATBOT_CONFIG = {
            apiEndpoint: 'https://myapp-chatbot-server.onrender.com/api/chat',
            apiEndpointLocal: 'http://localhost:3001/api/chat',
            maxTokens: 500,
            temperature: 0.7,
            model: 'gpt-4o-mini',
            maxHistory: 10,
            retryAttempts: 3,
            retryDelay: 1000,
            enableWebSearch: true,
            webSearchThreshold: 0.3
        };

        // Variabili globali
        let currentUser = null;
        let conversationHistory = [];
        let isProcessing = false;
        let totalTokensUsed = 0;
        let dirigenti = [];
        let conversationContext = {
            askingForDirigenti: false,
            waitingForLevel: false,
            waitingForProvince: false,
            currentLevel: null
        };

        // --- FUNZIONI DI UTILITÀ AURORA ---
        
        function addMessage(content, type = 'bot', timestamp = new Date(), hasWebSearch = false) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'flex items-start space-x-3 animate-fade-in';
            
            let webSearchBadge = '';
            if (hasWebSearch && type === 'bot') {
                webSearchBadge = '<div class="web-search-indicator">🌐 Ricerca Web Aurora</div>';
            }
            
            if (type === 'user') {
                messageDiv.innerHTML = `
                    <div class="flex-1"></div>
                    <div class="message-user rounded-3xl p-5 max-w-lg">
                        <div class="text-white text-base leading-relaxed font-semibold">${escapeHtml(content)}</div>
                        <div class="text-xs text-gray-100 mt-3 opacity-75 font-semibold">${timestamp.toLocaleTimeString('it-IT', {hour: '2-digit', minute: '2-digit'})}</div>
                    </div>
                    <div class="w-10 h-10 bg-gradient-to-br from-aurora to-magenta rounded-full flex items-center justify-center shadow-xl">
                        <span class="text-white text-lg font-bold">👤</span>
                    </div>
                `;
            } else if (type === 'system') {
                messageDiv.innerHTML = `
                    <div class="w-10 h-10 bg-gradient-to-br from-cyan to-teal rounded-full flex items-center justify-center shadow-xl">
                        <span class="text-white text-lg">ℹ️</span>
                    </div>
                    <div class="message-system rounded-3xl p-5 max-w-lg w-full">
                        <div class="text-white text-base leading-relaxed font-semibold">${content}</div>
                    </div>
                `;
            } else {
                messageDiv.innerHTML = `
                    <div class="w-10 h-10 bg-gradient-to-br from-cyan to-teal rounded-full flex items-center justify-center flex-shrink-0 shadow-xl">
                        <span class="text-white text-lg">🤖</span>
                    </div>
                    <div class="message-bot rounded-3xl p-5 max-w-lg">
                        ${webSearchBadge}
                        <div class="text-primary text-base leading-relaxed markdown-content font-semibold">${formatMessage(content)}</div>
                        <div class="text-xs text-gray-500 mt-3 font-semibold">${timestamp.toLocaleTimeString('it-IT', {hour: '2-digit', minute: '2-digit'})}</div>
                    </div>
                `;
            }
            
            messagesContainer.appendChild(messageDiv);
            
            // Scroll automatico con ritardo
            setTimeout(() => {
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }, 150);
        }

        async function loadDirigenti() {
            try {
                const { data, error } = await supabase
                    .from('organico_dirigentisindacali')
                    .select('*')
                    .order('id', { ascending: true });
                
                if (error) throw error;
                
                dirigenti = data || [];
                console.log('✅ Dirigenti Aurora caricati:', dirigenti.length);
                
            } catch (error) {
                console.error('❌ Errore caricamento dirigenti Aurora:', error);
                dirigenti = [
                    {
                        nome_cognome: 'Antonio Grande',
                        ruolo: 'Segretario Generale Regionale - Veneto',
                        email: 'veneto@carabinierinsic.it',
                        telefono: '3351470886'
                    },
                    {
                        nome_cognome: 'Andrea Modolo',
                        ruolo: 'Segretario Generale Regionale Vicario - Veneto',
                        email: 'veneto@carabinierinsic.it',
                        telefono: '3770969168'
                    }
                ];
            }
        }

        async function searchDirigentiByLevel(level) {
            try {
                let query = supabase.from('organico_dirigentisindacali').select('*');
                
                if (level === 'regionale') {
                    query = query.ilike('ruolo', '%Regionale%');
                } else if (level === 'provinciale') {
                    query = query.ilike('ruolo', '%Provinciale%');
                }
                
                const { data, error } = await query.order('id', { ascending: true });
                
                if (error) throw error;
                return data || [];
                
            } catch (error) {
                console.error('❌ Errore ricerca dirigenti Aurora per livello:', error);
                return [];
            }
        }

        async function searchDirigentiByProvince(province) {
            try {
                const { data, error } = await supabase
                    .from('organico_dirigentisindacali')
                    .select('*')
                    .ilike('ruolo', `%${province}%`)
                    .order('id', { ascending: true });
                
                if (error) throw error;
                return data || [];
                
            } catch (error) {
                console.error('❌ Errore ricerca dirigenti Aurora per provincia:', error);
                return [];
            }
        }

        function formatDirigentiList(dirigentiList, title) {
            if (!dirigentiList || dirigentiList.length === 0) {
                return `<strong>${title}</strong><br><br>❌ Nessun dirigente trovato per questa ricerca.`;
            }

            let result = `<strong class="text-aurora">${title}</strong><br><br>`;
            dirigentiList.forEach((dirigente, index) => {
                result += `<strong>${index + 1}. ${dirigente.nome_cognome}</strong><br>`;
                result += `📋 <em>${dirigente.ruolo}</em><br>`;
                if (dirigente.email) {
                    result += `📧 <a href="mailto:${dirigente.email}" class="text-aurora underline hover:text-cyan transition-colors">${dirigente.email}</a><br>`;
                }
                if (dirigente.telefono) {
                    result += `📞 <a href="tel:${dirigente.telefono}" class="text-aurora underline hover:text-cyan transition-colors">${dirigente.telefono}</a><br>`;
                }
                result += '<br>';
            });
            
            return result;
        }

        // Funzione per gestire logica dirigenti Aurora
        function handleDirigentiQuery(message) {
            const messageLower = message.toLowerCase();
            
            // Reset context se cambia argomento completamente
            if (!messageLower.includes('dirigent') && !messageLower.includes('regionale') && 
                !messageLower.includes('provinciale') && !conversationContext.askingForDirigenti && 
                !conversationContext.waitingForLevel && !conversationContext.waitingForProvince) {
                conversationContext = {
                    askingForDirigenti: false,
                    waitingForLevel: false,
                    waitingForProvince: false,
                    currentLevel: null
                };
                return null;
            }
            
            // 1. Prima richiesta dirigenti
            if ((messageLower.includes('dirigent') && messageLower.includes('sindacali')) || 
                messageLower.includes('chi sono i dirigenti') || 
                messageLower.includes('contatti dirigenti')) {
                
                conversationContext.askingForDirigenti = true;
                conversationContext.waitingForLevel = true;
                return {
                    type: 'ask_level',
                    message: `✨ Vuoi i contatti dei dirigenti sindacali a livello <strong class="text-aurora">Regionale</strong> o <strong class="text-aurora">Provinciale</strong>?<br><br>Scrivi semplicemente "<em>regionale</em>" o "<em>provinciale</em>".`
                };
            }
            
            // 2. Risposta livello
            if (conversationContext.waitingForLevel) {
                if (messageLower.includes('regionale')) {
                    conversationContext.waitingForLevel = false;
                    conversationContext.currentLevel = 'regionale';
                    return { type: 'search_regional' };
                } else if (messageLower.includes('provinciale')) {
                    conversationContext.waitingForLevel = false;
                    conversationContext.waitingForProvince = true;
                    conversationContext.currentLevel = 'provinciale';
                    return {
                        type: 'ask_province',
                        message: `🌟 Di quale <strong class="text-aurora">provincia</strong> hai bisogno?<br><br><em>Esempi: Verona, Padova, Venezia, Vicenza, Treviso, Belluno, Rovigo...</em>`
                    };
                } else {
                    // Se non riconosce la risposta, ripeti la domanda
                    return {
                        type: 'ask_level',
                        message: `❓ Non ho capito. Vuoi i contatti dei dirigenti sindacali a livello <strong class="text-aurora">Regionale</strong> o <strong class="text-aurora">Provinciale</strong>?<br><br>Scrivi "<em>regionale</em>" o "<em>provinciale</em>".`
                    };
                }
            }
            
            // 3. Risposta provincia
            if (conversationContext.waitingForProvince) {
                const province = ['verona', 'padova', 'venezia', 'vicenza', 'treviso', 'belluno', 'rovigo', 'veneto'];
                const foundProvince = province.find(p => messageLower.includes(p));
                
                if (foundProvince) {
                    conversationContext.waitingForProvince = false;
                    conversationContext.askingForDirigenti = false;
                    return { 
                        type: 'search_province',
                        province: foundProvince.charAt(0).toUpperCase() + foundProvince.slice(1)
                    };
                } else {
                    // Se non riconosce la provincia, ripeti la domanda
                    return {
                        type: 'ask_province',
                        message: `❓ Non ho trovato quella provincia. Di quale <strong class="text-aurora">provincia del Veneto</strong> hai bisogno?<br><br><em>Esempi: Verona, Padova, Venezia, Vicenza, Treviso, Belluno, Rovigo...</em>`
                    };
                }
            }
            
            return null;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatMessage(text) {
            return escapeHtml(text)
                .replace(/\*\*(.*?)\*\*/g, '<strong class="text-aurora">$1</strong>')
                .replace(/\*(.*?)\*/g, '<em class="text-gray-600">$1</em>')
                .replace(/\n/g, '<br>');
        }

        function showTyping() {
            document.getElementById('typingIndicator').classList.remove('hidden');
            const container = document.getElementById('chatMessages');
            setTimeout(() => {
                container.scrollTop = container.scrollHeight;
            }, 200);
        }

        function hideTyping() {
            document.getElementById('typingIndicator').classList.add('hidden');
        }

        function updateSendButton() {
            const input = document.getElementById('messageInput');
            const button = document.getElementById('sendMessage');
            const hasText = input.value.trim().length > 0;
            
            button.disabled = !hasText || isProcessing;
            if (button.disabled) {
                button.classList.add('opacity-50', 'cursor-not-allowed');
                button.classList.remove('hover:scale-108');
            } else {
                button.classList.remove('opacity-50', 'cursor-not-allowed');
                button.classList.add('hover:scale-108');
            }
        }

        function updateCharCount() {
            const input = document.getElementById('messageInput');
            const counter = document.getElementById('charCount');
            const current = input.value.length;
            counter.textContent = current;
            
            if (current > 400) {
                counter.classList.add('text-aurora');
                counter.classList.remove('text-ultra-visible');
            } else {
                counter.classList.remove('text-aurora');
                counter.classList.add('text-ultra-visible');
            }
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            const errorText = document.getElementById('errorText');
            
            errorText.textContent = message;
            errorDiv.classList.remove('hidden');
            
            setTimeout(() => {
                errorDiv.classList.add('hidden');
            }, 6000);
        }

        function hideError() {
            document.getElementById('errorMessage').classList.add('hidden');
        }

        function showSuccess(message) {
            const successDiv = document.getElementById('successMessage');
            const successText = document.getElementById('successText');
            
            successText.textContent = message;
            successDiv.classList.remove('hidden');
            
            setTimeout(() => {
                successDiv.classList.add('hidden');
            }, 4000);
        }

        function updateConnectionStatus(isConnected) {
            const status = document.getElementById('connectionStatus');
            if (isConnected) {
                status.className = 'w-3 h-3 bg-green-500 rounded-full connection-dot inline-block';
                status.title = 'Connesso ad Aurora';
            } else {
                status.className = 'w-3 h-3 bg-red-500 rounded-full inline-block';
                status.title = 'Disconnesso';
            }
        }

        function getApiEndpoint() {
            if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                console.log('🔧 Usando server locale Aurora per sviluppo');
                return CHATBOT_CONFIG.apiEndpointLocal;
            }
            
            console.log('🚀 Usando server chatbot Aurora Render:', CHATBOT_CONFIG.apiEndpoint);
            return CHATBOT_CONFIG.apiEndpoint;
        }

        // Inizializza la chat Aurora con messaggio di benvenuto aggiornato
        function initializeChat() {
            const messagesContainer = document.getElementById('chatMessages');
            
            // Reset conversation context
            conversationContext = {
                askingForDirigenti: false,
                waitingForLevel: false,
                waitingForProvince: false,
                currentLevel: null
            };

            // Rimuovi solo i messaggi dinamici, mantieni il welcome message
            const existingMessages = messagesContainer.querySelectorAll('.animate-fade-in:not(#welcomeMessage)');
            existingMessages.forEach(msg => msg.remove());
        }

        // Funzione per decidere se necessita ricerca web
        function needsWebSearch(message) {
            const webSearchKeywords = [
                'ultime notizie', 'news', 'aggiornamenti', 'recenti', 'oggi', 
                'attuale', 'corrente', 'nuovo', 'ultima', 'current',
                'stipendio 2025', 'contratto 2025', 'aumenti', 'novità',
                'legge', 'decreto', 'normativa', 'giurisprudenza',
                'confronta', 'vs', 'statistiche', 'dati', 'cifre',
                'cosa dice', 'secondo', 'fonte', 'verifica'
            ];
            
            const messageLower = message.toLowerCase();
            return webSearchKeywords.some(keyword => messageLower.includes(keyword));
        }

        // Invio messaggio Aurora
        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message || isProcessing) return;
            
            isProcessing = true;
            updateSendButton();
            
            // Aggiungi messaggio utente
            addMessage(message, 'user');
            conversationHistory.push({ role: 'user', content: message });
            
            // Pulisci input
            input.value = '';
            updateCharCount();
            updateSendButton();
            
            // **GESTIONE DIRIGENTI AURORA**
            const dirigentiAction = handleDirigentiQuery(message);
            
            if (dirigentiAction) {
                hideTyping();
                
                try {
                    if (dirigentiAction.type === 'ask_level' || dirigentiAction.type === 'ask_province') {
                        // Mostra domanda di follow-up
                        setTimeout(() => {
                            addMessage(dirigentiAction.message, 'bot');
                            conversationHistory.push({ role: 'assistant', content: dirigentiAction.message });
                        }, 1000);
                        
                    } else if (dirigentiAction.type === 'search_regional') {
                        // Cerca dirigenti regionali
                        showTyping();
                        const dirigentiRegionali = await searchDirigentiByLevel('regionale');
                        hideTyping();
                        
                        const responseMessage = formatDirigentiList(dirigentiRegionali, '📋 Dirigenti Sindacali Regionali Aurora');
                        setTimeout(() => {
                            addMessage(responseMessage, 'bot');
                            conversationHistory.push({ role: 'assistant', content: responseMessage });
                        }, 1000);
                        
                    } else if (dirigentiAction.type === 'search_province') {
                        // Cerca dirigenti provinciali
                        showTyping();
                        const dirigentiProvinciali = await searchDirigentiByProvince(dirigentiAction.province);
                        hideTyping();
                        
                        const responseMessage = formatDirigentiList(dirigentiProvinciali, `📋 Dirigenti Sindacali Aurora - ${dirigentiAction.province}`);
                        setTimeout(() => {
                            addMessage(responseMessage, 'bot');
                            conversationHistory.push({ role: 'assistant', content: responseMessage });
                        }, 1000);
                    }
                    
                } catch (error) {
                    console.error('❌ Errore gestione dirigenti Aurora:', error);
                    hideTyping();
                    showError('Errore nel recupero dei contatti dirigenti Aurora');
                }
                
                isProcessing = false;
                updateSendButton();
                input.focus();
                return;
            }
            
            // **GESTIONE NORMALE CHATBOT AURORA**
            
            // Mostra typing indicator
            showTyping();
            
            // Determina se serve ricerca web
            const requiresWebSearch = needsWebSearch(message);
            
            try {
                // Ottieni token di autenticazione
                const { data: { session } } = await supabase.auth.getSession();
                if (!session) {
                    throw new Error('Sessione scaduta');
                }

                // Determina endpoint API
                const apiEndpoint = getApiEndpoint();
                
                console.log('📡 Richiesta Aurora inviata:', {
                    enable_web_search: requiresWebSearch,
                    web_search_query: requiresWebSearch ? message : null,
                    model: CHATBOT_CONFIG.model,
                    messages_count: conversationHistory.slice(-CHATBOT_CONFIG.maxHistory).length
                });
                
                if (requiresWebSearch) {
                    console.log('🌐 Richiesta ricerca web Aurora abilitata per:', message);
                }

                // Crea prompt potenziato Aurora con info sui dirigenti
                let systemContext = `Sei Virgilio Aurora, assistente AI di nuova generazione del Sindacato Carabinieri. Rispondi in modo conciso, professionale e sempre utile.`;
                
                if (dirigenti.length > 0) {
                    systemContext += `\n\nCONTATTI DIRIGENTI SINDACATO AURORA:\n`;
                    dirigenti.forEach(dirigente => {
                        systemContext += `- ${dirigente.nome_cognome} (${dirigente.ruolo})`;
                        if (dirigente.email) systemContext += ` - ${dirigente.email}`;
                        if (dirigente.telefono) systemContext += ` - ${dirigente.telefono}`;
                        systemContext += '\n';
                    });
                }

                // Prepara richiesta con supporto ricerca web Aurora
                const requestBody = {
                    messages: conversationHistory.slice(-CHATBOT_CONFIG.maxHistory),
                    model: CHATBOT_CONFIG.model,
                    max_tokens: CHATBOT_CONFIG.maxTokens,
                    temperature: CHATBOT_CONFIG.temperature,
                    system_context: systemContext,
                    enable_web_search: requiresWebSearch,
                    web_search_query: requiresWebSearch ? message : null
                };

                // Chiamata API con retry Aurora
                let lastError = null;
                for (let attempt = 0; attempt < CHATBOT_CONFIG.retryAttempts; attempt++) {
                    try {
                        const response = await fetch(apiEndpoint, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${session.access_token}`
                            },
                            body: JSON.stringify(requestBody)
                        });

                        if (!response.ok) {
                            const errorData = await response.json().catch(() => ({}));
                            throw new Error(errorData.error || `HTTP ${response.status}`);
                        }

                        const data = await response.json();
                        
                        if (!data.choices || !data.choices[0] || !data.choices[0].message) {
                            throw new Error('Risposta API Aurora non valida');
                        }

                        const botResponse = data.choices[0].message.content;
                        const hasWebSearch = data.web_search_performed || false;
                        
                        // Aggiungi risposta del bot Aurora con indicatore ricerca web
                        addMessage(botResponse, 'bot', new Date(), hasWebSearch);
                        conversationHistory.push({ role: 'assistant', content: botResponse });
                        
                        // Aggiorna contatori
                        if (data.usage) {
                            totalTokensUsed += data.usage.total_tokens || 0;
                            document.getElementById('tokenCount').textContent = totalTokensUsed.toLocaleString();
                        }

                        // Log dettagli ricerca web Aurora
                        if (hasWebSearch) {
                            console.log('🌐 Ricerca web Aurora eseguita:', data.web_search_results || 'Risultati integrati');
                        } else if (requiresWebSearch) {
                            console.warn('⚠️ Ricerca web Aurora richiesta ma non eseguita dal server');
                        }

                        updateConnectionStatus(true);
                        console.log('✅ Messaggio Aurora inviato con successo');
                        break;
                        
                    } catch (error) {
                        lastError = error;
                        console.warn(`⚠️ Tentativo Aurora ${attempt + 1} fallito:`, error.message);
                        
                        if (attempt < CHATBOT_CONFIG.retryAttempts - 1) {
                            await new Promise(r => setTimeout(r, CHATBOT_CONFIG.retryDelay * (attempt + 1)));
                        }
                    }
                }

                if (lastError) {
                    throw lastError;
                }

            } catch (error) {
                console.error('❌ Errore invio messaggio Aurora:', error);
                
                // Rimuovi ultimo messaggio utente dalla cronologia
                conversationHistory.pop();
                
                // Mostra errore specifico Aurora
                let errorMessage = 'Errore di connessione Aurora';
                if (error.message.includes('scadut')) {
                    errorMessage = 'Sessione Aurora scaduta, riaccedi';
                } else if (error.message.includes('network') || error.message.includes('fetch')) {
                    errorMessage = 'Problema di rete Aurora, riprova';
                } else if (error.message.includes('500')) {
                    errorMessage = 'Servizio Aurora temporaneamente non disponibile';
                } else if (error.message.includes('401')) {
                    errorMessage = 'Autenticazione Aurora non valida';
                } else if (error.message.includes('404')) {
                    errorMessage = 'Server chatbot Aurora non trovato';
                }
                
                showError(errorMessage);
                updateConnectionStatus(false);
                
            } finally {
                hideTyping();
                isProcessing = false;
                updateSendButton();
                input.focus();
            }
        }

        async function verificaAutenticazione() {
            try {
                const { data: { session } } = await supabase.auth.getSession();
                
                if (!session) {
                    console.log('❌ Nessuna sessione Aurora attiva');
                    window.location.href = '../login.html';
                    return null;
                }

                console.log('✅ Utente Aurora autenticato:', session.user.email);
                return session.user;
                
            } catch (error) {
                console.error('❌ Errore verifica auth Aurora:', error);
                window.location.href = '../login.html';
                return null;
            }
        }

        async function testApiConnection() {
            try {
                const { data: { session } } = await supabase.auth.getSession();
                if (!session) return;

                const healthEndpoint = 'https://myapp-chatbot-server.onrender.com/api/health';
                
                console.log('🔍 Testando connessione API Aurora:', healthEndpoint);
                
                const response = await fetch(healthEndpoint, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${session.access_token}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    console.log('✅ Server chatbot Aurora raggiungibile:', data);
                    updateConnectionStatus(true);
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
                
            } catch (error) {
                console.warn('⚠️ Test connessione API Aurora fallito:', error.message);
                updateConnectionStatus(false);
                
                setTimeout(() => {
                    showError('Server chatbot Aurora non raggiungibile. Il servizio potrebbe essere in fase di avvio...');
                }, 3000);
            }
        }

        // Funzione Help Aurora
        window.showHelp = function() {
            const helpMessage = `🆘 <strong class="text-aurora">Assistenza Aurora Immediata</strong><br><br>

Per emergenze o questioni urgenti:<br><br>

📞 <strong>Telefono</strong>: 06-123456789<br>
📧 <strong>Email</strong>: assistenza@simcarabinieri.it<br>
🏢 <strong>Sede</strong>: Via Roma 123, Roma<br><br>

<strong class="text-aurora">Orari di ricevimento Aurora</strong>:<br>
• Lunedì-Venerdì: 9:00-17:00<br>
• Sabato: 9:00-12:00<br><br>

Per assistenza tecnica con l'app Aurora, contatta il supporto IT.<br><br>

<strong class="text-aurora">Comandi disponibili</strong>:<br>
• Usa le domande frequenti per risposte rapide<br>
• Digita "aiuto" per questa guida<br>
• Clicca 🗑️ per pulire la chat Aurora<br>
• Scrivi "dirigenti sindacali" per i contatti<br><br>

<em>Virgilio Aurora è sempre qui per aiutarti! ✨</em>`;

            addMessage(helpMessage, 'system');
        };

        // Setup Quick Replies Aurora
        function setupQuickReplies() {
            const quickReplies = document.querySelectorAll('.quick-reply');
            
            quickReplies.forEach(button => {
                button.addEventListener('click', () => {
                    const message = button.getAttribute('data-message');
                    if (message && !isProcessing) {
                        document.getElementById('messageInput').value = message;
                        updateSendButton();
                        updateCharCount();
                        // Auto-send quick replies
                        setTimeout(() => sendMessage(), 300);
                    }
                });
            });
        }

        // Event Listeners Aurora
        document.addEventListener('DOMContentLoaded', async () => {
            // Mostra loading
            document.getElementById('loading').classList.remove('hidden');
            
            try {
                // Verifica autenticazione
                currentUser = await verificaAutenticazione();
                if (!currentUser) return;

                // Carica dirigenti
                await loadDirigenti();

                // Setup quick replies
                setupQuickReplies();

                const input = document.getElementById('messageInput');
                const sendButton = document.getElementById('sendMessage');

                // Event listeners per input
                input.addEventListener('input', () => {
                    updateCharCount();
                    updateSendButton();
                });

                input.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendMessage();
                    }
                });

                sendButton.addEventListener('click', sendMessage);

                // Clear chat Aurora
                document.getElementById('clearChatBtn').addEventListener('click', () => {
                    if (confirm('Vuoi davvero cancellare tutta la conversazione Aurora?')) {
                        conversationHistory = [];
                        totalTokensUsed = 0;
                        document.getElementById('tokenCount').textContent = '0';
                        initializeChat();
                        showSuccess('Chat Aurora cancellata con successo! ✨');
                    }
                });

                // Logout Aurora
                document.getElementById('logoutBtn').addEventListener('click', async () => {
                    if (confirm('Vuoi davvero disconnetterti da Aurora?')) {
                        await supabase.auth.signOut();
                        window.location.href = '../login.html';
                    }
                });

                // Focus sull'input
                input.focus();
                updateSendButton();

                // Test connessione API all'avvio
                testApiConnection();

                console.log('🤖✨ Virgilio Aurora inizializzato con successo!');
                
            } catch (error) {
                console.error('❌ Errore inizializzazione Aurora:', error);
                showError('Errore di inizializzazione Aurora. Ricarica la pagina.');
            } finally {
                // Nascondi loading
                document.getElementById('loading').classList.add('hidden');
            }
        });

        // Gestione errori globali Aurora
        window.addEventListener('error', (event) => {
            console.error('❌ Errore JavaScript Aurora:', event.error);
            showError('Si è verificato un errore imprevisto in Aurora');
        });

        window.addEventListener('unhandledrejection', (event) => {
            console.error('❌ Promise rejected Aurora:', event.reason);
            showError('Errore di rete o server Aurora');
        });

        // Gestione visibilità pagina Aurora
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden && currentUser) {
                testApiConnection();
            }
        });

        // Gestione comandi speciali Aurora
        function handleSpecialCommands(message) {
            const lowerMessage = message.toLowerCase().trim();
            
            if (lowerMessage === 'aiuto' || lowerMessage === 'help') {
                showHelp();
                return true;
            }
            
            if (lowerMessage === 'stato' || lowerMessage === 'status') {
                const statusMessage = `📊 <strong class="text-aurora">Stato Sistema Aurora</strong><br><br>

🔗 <strong>Connessione</strong>: ${document.getElementById('connectionStatus').classList.contains('bg-green-500') ? 'Attiva ✅' : 'Disconnessa ❌'}<br>
🤖 <strong>Modello AI</strong>: ${CHATBOT_CONFIG.model}<br>
📝 <strong>Token utilizzati</strong>: ${totalTokensUsed.toLocaleString()}<br>
💬 <strong>Messaggi nella cronologia</strong>: ${conversationHistory.length / 2}<br>
🌐 <strong>Ricerca Web</strong>: ${CHATBOT_CONFIG.enableWebSearch ? 'Abilitata ✅' : 'Disabilitata ❌'}<br>
⏰ <strong>Sessione attiva</strong>: ${Math.floor((Date.now() - performance.timeOrigin) / 60000)} minuti<br><br>

<em>Il sistema Aurora è operativo e pronto ad assisterti! ✨</em>`;
                
                addMessage(statusMessage, 'system');
                return true;
            }
            
            return false;
        }

        // Modifica la funzione sendMessage per gestire comandi speciali
        const originalSendMessage = sendMessage;
        sendMessage = async function() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            // Controlla comandi speciali prima di inviare
            if (handleSpecialCommands(message)) {
                input.value = '';
                updateSendButton();
                updateCharCount();
                return;
            }
            
            // Esegui la funzione originale
            return originalSendMessage();
        };

        // Debug info Aurora
        console.log('🤖✨ Virgilio Aurora Chat con Dirigenti Sindacali inizializzata');
        console.log('🔧 Configurazione Aurora:', CHATBOT_CONFIG);
        console.log('🌐 Ricerca web Aurora abilitata:', CHATBOT_CONFIG.enableWebSearch);
        console.log('👥 Gestione dirigenti Aurora abilitata');
        console.log('✨ Stile Aurora Boreale 2025 attivo');
    </script>

    <!-- Smart Navigation System -->
    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
        
        const supabase = createClient(
            'https://lycrgzptkdkksukcwrld.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx5Y3JnenB0a2Rra3N1a2N3cmxkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI3ODQyMzAsImV4cCI6MjA2ODM2MDIzMH0.ZJGOXAMC3hKKrnwXHKEa2_Eh7ZpOKeLYvYlYneBiEfk'
        );

        // Smart Home Redirect Aurora
        async function smartHomeRedirect() {
            try {
                const { data: { user } } = await supabase.auth.getUser();
                
                if (!user) {
                    window.location.href = '../login.html';
                    return;
                }

                // Ottieni ruoli utente
                const { data: profile } = await supabase
                    .from('profiles')
                    .select('ruoli')
                    .eq('id', user.id)
                    .single();

                const userRoles = profile?.ruoli || ['USER'];
                
                // Determina la home corretta
                if (userRoles.includes('DIRIGENTE') || userRoles.includes('ADMIN')) {
                    window.location.href = '../app/home_dirigenti.html';
                } else {
                    window.location.href = '../app/home.html';
                }
            } catch (error) {
                console.error('Errore smart navigation Aurora:', error);
                window.location.href = '../app/home.html';
            }
        }

        // Esponi globalmente
        window.smartHomeRedirect = smartHomeRedirect;
    </script>
</body>
</html>
                    error<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Virgilio Aurora - MyApp</title>

    <!-- PWA Meta Tags -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#1a1a2e">
    <meta name="background-color" content="#1a1a2e">

    <!-- Icone Standard -->
    <link rel="icon" type="image/png" sizes="16x16" href="/icons/favicon-16x16.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="/icons/favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="192x192" href="/icons/icon-192x192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="/icons/icon-512x512.png">

    <!-- iOS Support -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="MyApp">
    <link rel="apple-touch-icon" href="/icons/apple-touch-icon.png">

    <!-- Android Support -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="MyApp">
    <meta name="msapplication-TileColor" content="#1a1a2e">

    <!-- Preconnect per performance -->
    <link rel="preconnect" href="https://cdn.tailwindcss.com">
    <link rel="preconnect" href="https://cdn.jsdelivr.net">

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        // Aurora Boreale 2025 Palette
                        primary: '#1a1a2e',
                        secondary: '#16213e',
                        accent: '#0f3460',
                        aurora: '#e94560',
                        cyan: '#00d4ff',
                        magenta: '#ff006e',
                        gold: '#ffd700',
                        teal: '#03dac6',
                        dark: '#0a0a23',
                        light: '#f8fafc'
                    },
                    screens: {
                        'xs': '320px',
                        'sm': '640px',
                        'md': '768px',
                        'lg': '1024px',
                        'xl': '1280px',
                        '2xl': '1536px',
                        '3xl': '1920px',
                        '4xl': '2560px'
                    }
                }
            }
        }
    </script>
    <style>
        :root {
            --gradient-aurora: linear-gradient(135deg, #1a1a2e 0%, #16213e 25%, #0f3460 50%, #e94560 75%, #00d4ff 100%);
            --gradient-cyber: linear-gradient(135deg, #0a0a23 0%, #1a1a2e 50%, #00d4ff 100%);
            --gradient-magic: linear-gradient(135deg, #ff006e 0%, #e94560 50%, #03dac6 100%);
        }

        body {
            background: var(--gradient-aurora);
            background-size: 400% 400%;
            animation: aurora 20s ease infinite;
            min-height: 100vh;
            font-family: 'Segoe UI', Roboto, sans-serif;
        }

        @keyframes aurora {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-15px); }
        }

        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

        @keyframes glow {
            0%, 100% { box-shadow: 0 0 30px rgba(233, 69, 96, 0.4); }
            50% { box-shadow: 0 0 50px rgba(233, 69, 96, 0.8), 0 0 70px rgba(0, 212, 255, 0.4); }
        }

        @keyframes typing {
            0%, 80%, 100% { transform: scale(0); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        .text-ultra-visible {
            color: #ffffff;
            text-shadow: 0 8px 25px rgba(0, 0, 0, 0.9), 0 4px 12px rgba(0, 0, 0, 0.8), 0 2px 6px rgba(0, 0, 0, 1);
            font-weight: 800;
        }

        .hero-title {
            font-size: clamp(2rem, 8vw, 3.5rem);
            font-weight: 900;
        }

        .glass-morphism {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.18);
            box-shadow: 0 12px 40px 0 rgba(31, 38, 135, 0.37);
        }

        .glass-strong {
            background: rgba(255, 255, 255, 0.12);
            backdrop-filter: blur(24px);
            border: 1px solid rgba(255, 255, 255, 0.25);
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
        }

        .btn-aurora {
            background: var(--gradient-magic);
            color: white;
            border: 2px solid rgba(233, 69, 96, 0.3);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .btn-aurora::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.6s;
        }

        .btn-aurora:hover::before {
            left: 100%;
        }

        .btn-aurora:hover {
            transform: translateY(-3px) scale(1.08);
            box-shadow: 0 20px 40px rgba(233, 69, 96, 0.5);
            border-color: rgba(233, 69, 96, 0.7);
        }

        .btn-cyber {
            background: var(--gradient-cyber);
            border: 2px solid rgba(0, 212, 255, 0.3);
            color: white;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .btn-cyber:hover {
            transform: translateY(-3px) scale(1.08);
            box-shadow: 0 20px 40px rgba(0, 212, 255, 0.5);
            border-color: rgba(0, 212, 255, 0.7);
        }

        /* Chat Messages Aurora Style */
        .message-bot {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(16px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .message-user {
            background: var(--gradient-magic);
            color: white;
            box-shadow: 0 8px 32px rgba(233, 69, 96, 0.4);
            border: 1px solid rgba(233, 69, 96, 0.3);
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .message-system {
            background: var(--gradient-cyber);
            color: white;
            box-shadow: 0 8px 32px rgba(0, 212, 255, 0.4);
            border: 1px solid rgba(0, 212, 255, 0.3);
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .chat-input {
            background: rgba(255, 255, 255, 0.9) !important;
            backdrop-filter: blur(12px);
            border: 2px solid rgba(255, 255, 255, 0.3) !important;
            border-radius: 16px !important;
            transition: all 0.4s ease !important;
            color: #1a1a2e !important;
            font-weight: 600;
        }

        .chat-input:focus {
            background: rgba(255, 255, 255, 0.98) !important;
            border-color: #e94560 !important;
            box-shadow: 0 0 30px rgba(233, 69, 96, 0.4) !important;
            outline: none !important;
        }

        .chat-input::placeholder {
            color: rgba(26, 26, 46, 0.6) !important;
            font-weight: 500;
        }

        .typing-animation {
            width: 6px;
            height: 6px;
            background: var(--gradient-magic);
            border-radius: 50%;
            animation: typing 1.6s infinite ease-in-out;
            margin: 0 2px;
        }

        .typing-animation:nth-child(2) { animation-delay: 0.3s; }
        .typing-animation:nth-child(3) { animation-delay: 0.6s; }

        .error-message {
            background: rgba(239, 68, 68, 0.1);
            border: 2px solid rgba(239, 68, 68, 0.3);
            color: #dc2626;
            backdrop-filter: blur(12px);
        }

        .success-message {
            background: rgba(34, 197, 94, 0.1);
            border: 2px solid rgba(34, 197, 94, 0.3);
            color: #16a34a;
            backdrop-filter: blur(12px);
        }

        .animate-fade-in {
            animation: fadeIn 0.6s ease-out;
        }

        .connection-dot {
            animation: pulse 2s infinite;
        }

        .web-search-indicator {
            background: var(--gradient-cyber);
            color: white;
            font-size: 12px;
            font-weight: 700;
            padding: 4px 12px;
            border-radius: 12px;
            display: inline-block;
            margin-bottom: 8px;
            text-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
            box-shadow: 0 4px 15px rgba(0, 212, 255, 0.3);
        }

        .quick-reply {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
        }

        .quick-reply:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 8px 25px rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 255, 255, 0.4);
        }

        .markdown-content strong {
            font-weight: 800;
            color: #1a1a2e;
        }

        .markdown-content em {
            font-style: italic;
            color: #374151;
        }

        .floating {
            animation: float 8s ease-in-out infinite;
        }

        .floating:nth-child(2) {
            animation-delay: -2s;
        }

        .floating:nth-child(3) {
            animation-delay: -4s;
        }

        .floating:nth-child(4) {
            animation-delay: -6s;
        }

        /* Header glass effect */
        .header-glass {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Chat container */
        .chat-container {
            scrollbar-width: thin;
            scrollbar-color: rgba(233, 69, 96, 0.3) transparent;
        }

        .chat-container::-webkit-scrollbar {
            width: 6px;
        }

        .chat-container::-webkit-scrollbar-track {
            background: transparent;
        }

        .chat-container::-webkit-scrollbar-thumb {
            background: rgba(233, 69, 96, 0.3);
            border-radius: 3px;
        }

        .chat-container::-webkit-scrollbar-thumb:hover {
            background: rgba(233, 69, 96, 0.5);
        }

        /* Loading animation */
        .loading-spinner {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Button hover effects */
        .button-hover {
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .button-hover:hover {
            transform: translateY(-2px) scale(1.05);
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .hero-title {
                font-size: clamp(1.5rem, 6vw, 2.5rem);
            }

            .glass-morphism,
            .glass-strong,
            .glass-card {
                backdrop-filter: blur(12px);
            }
        }

        /* Reduced motion support */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="w-full px-4 py-6 relative z-10 header-glass">
        <div class="max-w-2xl mx-auto flex justify-between items-center">
            <div class="flex items-center space-x-4">
                <button onclick="history.back()" class="text-ultra-visible hover:text-cyan transition-all duration-300 transform hover:scale-110">
                    <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M15 19l-7-7 7-7"></path>
                    </svg>
                </button>
                <div class="flex items-center space-x-3 floating">
                    <div class="w-12 h-12 bg-gradient-to-br from-cyan to-teal rounded-full flex items-center justify-center shadow-2xl">
                        <span class="text-white font-bold text-xl">🤖</span>
                    </div>
                    <div>
                        <h1 class="text-2xl font-black text-ultra-visible">Virgilio Aurora</h1>
                        <div id="connectionStatus" class="w-3 h-3 bg-green-500 rounded-full connection-dot inline-block" title="Connesso"></div>
                        <span class="text-sm text-ultra-visible opacity-90 ml-2">AI Assistant</span>
                    </div>
                </div>
            </div>
            <div class="flex items-center space-x-3">
                <button id="clearChatBtn" class="btn-cyber button-hover text-xs px-4 py-2 rounded-full font-bold shadow-xl" title="Pulisci Chat">
                    🗑️ Clear
                </button>
                <button id="logoutBtn" class="btn-aurora button-hover text-sm px-5 py-2 rounded-full font-bold shadow-xl">
                    ✨ Logout
                </button>
            </div>
        </div>
    </header>

    <!-- Loading -->
    <div id="loading" class="fixed inset-0 bg-dark bg-opacity-90 flex items-center justify-center z-50 hidden">
        <div class="glass-card rounded-2xl p-8 text-center">
            <div class="loading-spinner rounded-full h-16 w-16 border-b-4 border-aurora mx-auto mb-6"></div>
            <p class="text-primary font-bold text-lg">Caricamento Virgilio Aurora...</p>
        </div>
    </div>

    <!-- Main Content -->
    <main class="max-w-2xl mx-auto px-4 pb-32">
        <!-- Chat Header Info -->
        <div class="glass-strong rounded-3xl p-6 mb-6 text-center floating">
            <h2 class="text-2xl font-black text-ultra-visible mb-3">Il tuo Assistente Sindacale AI ✨</h2>
            <p class="text-lg text-ultra-visible opacity-90 mb-4">Chiedi informazioni su contratti, diritti, procedure e dirigenti sindacali!</p>
            <div class="text-sm text-ultra-visible opacity-75 bg-white/10 rounded-xl p-3 backdrop-blur-md">
                <span class="font-bold">Powered by</span> OpenAI GPT-4 • <span class="font-bold">Sicuro e Privato</span> • <span class="font-bold">Ricerca Web Integrata</span> 🌐
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="mb-6 floating">
            <h3 class="text-ultra-visible font-black mb-4 text-lg">💡 Domande Frequenti Aurora</h3>
            <div class="grid grid-cols-2 gap-3">
                <button class="quick-reply text-xs p-4 rounded-2xl font-bold" data-message="Dimmi tutto sul contratto di lavoro dei Carabinieri">
                    📋 Contratto di lavoro
                </button>
                <button class="quick-reply text-xs p-4 rounded-2xl font-bold" data-message="Come funzionano i permessi per malattia?">
                    🏥 Permessi malattia
                </button>
                <button class="quick-reply text-xs p-4 rounded-2xl font-bold" data-message="Quali sono i miei diritti per ferie e permessi?">
                    🏖️ Ferie e permessi
                </button>
                <button class="quick-reply text-xs p-4 rounded-2xl font-bold" data-message="Informazioni su stipendio e progressioni di carriera">
                    💰 Stipendio e aumenti
                </button>
                <button class="quick-reply text-xs p-4 rounded-2xl font-bold" data-message="Chi sono i dirigenti sindacali?">
                    👥 Dirigenti sindacali
                </button>
                <button class="quick-reply text-xs p-4 rounded-2xl font-bold" data-message="Procedure disciplinari e ricorsi">
                    📝 Procedure legali
                </button>
            </div>
        </div>

        <!-- Chat Messages -->
        <div id="chatMessages" class="chat-container space-y-4 overflow-y-auto mb-6" style="height: calc(100vh - 400px); min-height: 300px;">
            <!-- Welcome Message -->
            <div class="flex items-start space-x-3 animate-fade-in" id="welcomeMessage">
                <div class="w-10 h-10 bg-gradient-to-br from-cyan to-teal rounded-full flex items-center justify-center flex-shrink-0 shadow-xl">
                    <span class="text-white text-lg">🤖</span>
                </div>
                <div class="message-bot rounded-3xl p-5 max-w-lg">
                    <div class="text-primary text-base markdown-content font-semibold">
                        Ciao! Sono <strong>Virgilio Aurora</strong> ✨, il tuo assistente sindacale AI di nuova generazione. 
                        <br><br>
                        Sono qui per aiutarti con informazioni su <em>contratti, diritti, procedure</em> e tutto ciò che riguarda la vita professionale dei Carabinieri.
                        <br><br>
                        🌐 <strong>Novità:</strong> Ora posso effettuare ricerche web in tempo reale per fornirti informazioni sempre aggiornate!
                        <br><br>
                        <strong>Come posso aiutarti oggi?</strong>
                    </div>
                    <span class="text-xs text-gray-500 mt-3 block font-semibold">Ora</span>
                </div>
            </div>
        </div>

        <!-- Typing Indicator -->
        <div id="typingIndicator" class="flex items-start space-x-3 hidden mb-6 animate-fade-in">
            <div class="w-10 h-10 bg-gradient-to-br from-cyan to-teal rounded-full flex items-center justify-center shadow-xl">
                <span class="text-white text-lg">🤖</span>
            </div>
            <div class="message-bot rounded-3xl p-5 max-w-lg">
                <div class="flex space-x-1 justify-center items-center">
                    <div class="typing-animation"></div>
                    <div class="typing-animation"></div>
                    <div class="typing-animation"></div>
                </div>
                <div class="text-xs text-gray-500 mt-2 text-center font-semibold">Virgilio sta digitando...</div>
            </div>
        </div>

        <!-- Error Message -->
        <div id="errorMessage" class="error-message rounded-2xl p-5 mb-6 text-center hidden">
            <p class="font-black text-lg">⚠️ Errore di Connessione Aurora</p>
            <p class="text-sm mt-2 font-semibold" id="errorText">Impossibile contattare il server. Riprova tra poco.</p>
            <button onclick="hideError()" class="text-xs underline mt-3 font-bold hover:no-underline transition-all">Chiudi</button>
        </div>

        <!-- Success Message -->
        <div id="successMessage" class="success-message rounded-2xl p-5 mb-6 text-center hidden">
            <p class="font-black text-lg">✅ Operazione Completata</p>
            <p class="text-sm mt-2 font-semibold" id="successText">Chat pulita con successo!</p>
        </div>
    </main>

    <!-- Chat Input -->
    <div class="fixed bottom-20 left-0 right-0 px-4 pb-6 z-20 bg-gradient-to-t from-dark/90 via-dark/70 to-transparent pt-8">
        <div class="max-w-2xl mx-auto">
            <div class="glass-strong rounded-3xl p-6 shadow-2xl">
                <div class="flex items-center space-x-4">
                    <input 
                        type="text" 
                        id="messageInput" 
                        placeholder="✨ Scrivi la tua domanda..." 
                        class="chat-input flex-1 text-lg py-4 px-6"
                        maxlength="500"
                        autocomplete="off"
                    />
                    <button 
                        id="sendMessage" 
                        class="btn-aurora w-14 h-14 rounded-full flex items-center justify-center transition-all shadow-2xl disabled:opacity-50 disabled:cursor-not-allowed"
                        disabled
                        title="Invia messaggio"
                    >
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                        </svg>
                    </button>
                </div>
                <div class="flex justify-between items-center mt-4 px-6">
                    <div class="text-sm text-ultra-visible opacity-75 font-semibold">
                        <span id="charCount">0</span>/500 caratteri
                    </div>
                    <div class="text-sm text-ultra-visible opacity-75 font-semibold" id="tokenInfo">
                        Token utilizzati: <span id="tokenCount">0</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

   
    <!-- Bottom Navigation -->
    <nav class="fixed bottom-0 left-0 right-0 bg-gradient-to-r from-primary/90 to-secondary/90 backdrop-blur-lg border-t border-white/20 px-4 py-3 z-50 shadow-2xl">
        <div class="flex justify-around items-center max-w-md mx-auto">
            <a href="#" onclick="smartHomeRedirect()" class="nav-item group flex flex-col items-center transition-all duration-300 hover:scale-110">
                <div class="p-2 rounded-xl bg-white/10 group-hover:bg-white/20 transition-all duration-300">
                    <svg class="w-6 h-6 mb-1 text-white group-hover:text-aurora transition-colors" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"/>
                    </svg>
                </div>
                <span class="text-white font-bold text-xs group-hover:text-aurora transition-colors">Home</span>
            </a>
            
            <a href="../convenzioni.html" class="nav-item group flex flex-col items-center transition-all duration-300 hover:scale-110">
                <div class="p-2 rounded-xl bg-white/10 group-hover:bg-white/20 transition-all duration-300">
                    <svg class="w-6 h-6 mb-1 text-white group-hover:text-cyan transition-colors" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M4 4a2 2 0 00-2 2v1h16V6a2 2 0 00-2-2H4zM18 9H2v5a2 2 0 002 2h12a2 2 0 002-2V9zM4 13a1 1 0 011-1h1a1 1 0 110 2H5a1 1 0 01-1-1zm5-1a1 1 0 100 2h1a1 1 0 100-2H9z"/>
                    </svg>
                </div>
                <span class="text-white font-bold text-xs group-hover:text-cyan transition-colors">Convenzioni</span>
            </a>
            
            <a href="tessera.html" class="nav-item group flex flex-col items-center transition-all duration-300 hover:scale-110">
                <div class="p-2 rounded-xl bg-white/10 group-hover:bg-white/20 transition-all duration-300">
                    <svg class="w-6 h-6 mb-1 text-white group-hover:text-teal transition-colors"