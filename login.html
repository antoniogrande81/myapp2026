<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Accedi - MyApp Sindacato Carabinieri</title>
    
    <!-- PWA Meta Tags -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#1a1a2e">
    <meta name="background-color" content="#1a1a2e">

    <!-- Icone -->
    <link rel="icon" type="image/png" sizes="32x32" href="/public/icons/favicon-32x32.png">
    <link rel="apple-touch-icon" href="/public/icons/apple-touch-icon.png">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Appwrite SDK -->
    <script src="https://cdn.jsdelivr.net/npm/appwrite@13.0.1"></script>
    
    <!-- CONFIGURAZIONE COLORI TAILWIND -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        // Aurora Boreale 2025 Palette
                        primary: '#1a1a2e',      // Blu notte profondo
                        secondary: '#16213e',     // Blu oceano
                        accent: '#0f3460',        // Blu acciaio
                        aurora: '#e94560',        // Rosa aurora
                        cyan: '#00d4ff',          // Cyan elettrico
                        magenta: '#ff006e',       // Magenta vibrante
                        gold: '#ffd700',          // Oro elegante
                        teal: '#03dac6',          // Teal premium
                        dark: '#0a0a23',          // Nero cyber
                        light: '#f8fafc',         // Bianco ghiaccio
                        textDark: '#1C1C1E',
                        backgroundLight: '#F4F4F8',
                    }
                }
            }
        }
    </script>
    
    <!-- STILI CSS AURORA BOREALE -->
    <style>
        /* === VARIABILI CSS === */
        :root {
            --gradient-aurora: linear-gradient(135deg, #1a1a2e 0%, #16213e 25%, #0f3460 50%, #e94560 75%, #00d4ff 100%);
            --gradient-cyber: linear-gradient(135deg, #0a0a23 0%, #1a1a2e 50%, #00d4ff 100%);
            --gradient-magic: linear-gradient(135deg, #ff006e 0%, #e94560 50%, #03dac6 100%);
        }

        /* === SFONDO PRINCIPALE === */
        body {
            background: var(--gradient-aurora);
            background-size: 400% 400%;
            animation: aurora 20s ease infinite;
            min-height: 100vh;
        }

        /* === ANIMAZIONI === */
        @keyframes aurora {
            0%, 100% { background-position: 0% 50%; }
            25% { background-position: 100% 50%; }
            50% { background-position: 100% 100%; }
            75% { background-position: 0% 100%; }
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        @keyframes glow {
            0%, 100% { box-shadow: 0 0 20px rgba(233, 69, 96, 0.5); }
            50% { box-shadow: 0 0 40px rgba(0, 212, 255, 0.8); }
        }

        /* === TIPOGRAFIA ULTRA-VISIBILE === */
        .text-ultra-visible {
            color: #ffffff;
            text-shadow: 0 8px 25px rgba(0, 0, 0, 0.9), 0 4px 12px rgba(0, 0, 0, 0.8), 0 2px 6px rgba(0, 0, 0, 1);
            font-weight: 800;
        }

        .text-white {
            text-shadow: 0 8px 25px rgba(0, 0, 0, 0.9), 0 4px 12px rgba(0, 0, 0, 0.8), 0 2px 6px rgba(0, 0, 0, 1);
        }

        /* === GLASSMORPHISM === */
        .glass-effect {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        /* === CONTAINER PRINCIPALE === */
        .auth-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            padding: 2.5rem;
            width: 100%;
            max-width: 450px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.3);
            animation: float 6s ease-in-out infinite;
        }

        /* === HEADER === */
        .auth-header {
            text-align: center;
            margin-bottom: 2.5rem;
        }

        .auth-logo {
            width: 80px;
            height: 80px;
            background: var(--gradient-magic);
            border-radius: 20px;
            margin: 0 auto 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            animation: glow 3s ease-in-out infinite;
        }

        .auth-title {
            color: #1a1a2e;
            font-size: 2rem;
            font-weight: 900;
            margin-bottom: 0.5rem;
        }

        .auth-subtitle {
            color: #6b7280;
            font-size: 1rem;
            font-weight: 600;
        }

        /* === TABS === */
        .auth-tabs {
            display: flex;
            background: rgba(233, 69, 96, 0.1);
            border-radius: 16px;
            padding: 8px;
            margin-bottom: 2rem;
        }

        .auth-tab {
            flex: 1;
            padding: 12px 20px;
            border-radius: 12px;
            font-weight: 700;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .auth-tab:not(.active) {
            color: #6b7280;
            background: transparent;
        }

        .auth-tab:not(.active):hover {
            color: #374151;
            background: rgba(255, 255, 255, 0.5);
        }

        .auth-tab.active {
            background: var(--gradient-magic);
            color: white;
            box-shadow: 0 8px 25px rgba(233, 69, 96, 0.3);
            transform: translateY(-2px);
        }

        /* === FORM === */
        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 700;
            color: #374151;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .input-wrapper {
            position: relative;
        }

        .form-input {
            width: 100%;
            padding: 1rem 1rem 1rem 3rem;
            border: 2px solid #e5e7eb;
            border-radius: 16px;
            font-size: 1rem;
            font-weight: 600;
            background: #ffffff;
            color: #1f2937;
            transition: all 0.3s ease;
            outline: none;
        }

        .form-input:focus {
            border-color: #e94560;
            box-shadow: 0 0 0 4px rgba(233, 69, 96, 0.1);
            transform: scale(1.02);
        }

        .form-input::placeholder {
            color: #9ca3af;
            font-weight: 500;
        }

        .input-icon {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: #6b7280;
            font-size: 1.2rem;
        }

        .password-toggle {
            position: absolute;
            right: 1rem;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #6b7280;
            cursor: pointer;
            font-size: 1.2rem;
            padding: 0.25rem;
            border-radius: 6px;
            transition: all 0.2s ease;
        }

        .password-toggle:hover {
            color: #374151;
            background: rgba(0, 0, 0, 0.05);
        }

        /* === BOTTONE PRINCIPALE === */
        .auth-button {
            width: 100%;
            padding: 1rem 2rem;
            background: var(--gradient-magic);
            color: white;
            border: none;
            border-radius: 16px;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 1.5rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            border: 2px solid rgba(233, 69, 96, 0.3);
        }

        .auth-button:hover:not(:disabled) {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 20px 40px rgba(233, 69, 96, 0.4);
            border-color: rgba(233, 69, 96, 0.8);
        }

        .auth-button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* === MESSAGGI === */
        .message {
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 12px;
            font-weight: 600;
            text-align: center;
            border: 2px solid;
        }

        .message-error {
            background: rgba(220, 38, 38, 0.1);
            color: #dc2626;
            border-color: rgba(220, 38, 38, 0.3);
        }

        .message-success {
            background: rgba(22, 163, 74, 0.1);
            color: #16a34a;
            border-color: rgba(22, 163, 74, 0.3);
        }

        .message-info {
            background: rgba(37, 99, 235, 0.1);
            color: #2563eb;
            border-color: rgba(37, 99, 235, 0.3);
        }

        /* === HELPER TEXT === */
        .helper-text {
            font-size: 0.8rem;
            color: #6b7280;
            margin-top: 0.25rem;
            font-weight: 500;
        }

        /* === LINK === */
        .auth-link {
            text-align: center;
            margin-top: 1rem;
        }

        .auth-link a {
            color: #6b7280;
            text-decoration: none;
            font-size: 0.9rem;
            font-weight: 600;
            transition: color 0.2s ease;
        }

        .auth-link a:hover {
            color: #e94560;
        }

        /* === LOADING SPINNER === */
        .loading-spinner {
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 0.5rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* === RESPONSIVE === */
        @media (max-width: 480px) {
            .auth-container {
                padding: 2rem 1.5rem;
                margin: 1rem;
                border-radius: 20px;
            }
            
            .auth-title {
                font-size: 1.8rem;
            }
            
            .auth-logo {
                width: 70px;
                height: 70px;
                font-size: 2rem;
            }

            .form-input {
                padding: 0.9rem 0.9rem 0.9rem 2.75rem;
            }

            .input-icon {
                left: 0.9rem;
            }

            .password-toggle {
                right: 0.9rem;
            }
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">
    <div class="auth-container">
        <!-- HEADER -->
        <div class="auth-header">
            <div class="auth-logo">üöÄ</div>
            <h1 class="auth-title" id="authTitle">Accedi</h1>
            <p class="auth-subtitle" id="authSubtitle">Inserisci le tue credenziali</p>
        </div>
        
        <!-- TABS -->
        <div class="auth-tabs">
            <div class="auth-tab active" id="loginTab" onclick="switchToLogin()">
                Accedi
            </div>
            <div class="auth-tab" id="registerTab" onclick="switchToRegister()">
                Registrati
            </div>
        </div>
        
        <!-- MESSAGGI -->
        <div id="messages"></div>
        
        <!-- FORM LOGIN -->
        <form id="loginForm" style="display: block;">
            <div class="form-group">
                <label class="form-label" for="loginEmail">Email</label>
                <div class="input-wrapper">
                    <span class="input-icon">üìß</span>
                    <input 
                        type="email" 
                        id="loginEmail" 
                        class="form-input"
                        placeholder="mario.rossi@esempio.com"
                        required 
                        autocomplete="email"
                    >
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label" for="loginPassword">Password</label>
                <div class="input-wrapper">
                    <span class="input-icon">üîí</span>
                    <input 
                        type="password" 
                        id="loginPassword" 
                        class="form-input"
                        placeholder="Inserisci la tua password"
                        required 
                        autocomplete="current-password"
                    >
                    <button type="button" class="password-toggle" onclick="togglePassword('loginPassword', this)">
                        üëÅÔ∏è
                    </button>
                </div>
            </div>
            
            <button type="submit" class="auth-button" id="loginBtn">
                <span id="loginBtnText">üîê Accedi</span>
            </button>
        </form>
        
        <!-- FORM REGISTRAZIONE -->
        <form id="registerForm" style="display: none;">
            <div class="form-group">
                <label class="form-label" for="registerName">Nome Completo</label>
                <div class="input-wrapper">
                    <span class="input-icon">üë§</span>
                    <input 
                        type="text" 
                        id="registerName" 
                        class="form-input"
                        placeholder="Mario Rossi"
                        required 
                        autocomplete="name"
                    >
                </div>
                <div class="helper-text">Nome e cognome completi</div>
            </div>
            
            <div class="form-group">
                <label class="form-label" for="registerEmail">Email</label>
                <div class="input-wrapper">
                    <span class="input-icon">üìß</span>
                    <input 
                        type="email" 
                        id="registerEmail" 
                        class="form-input"
                        placeholder="mario.rossi@esempio.com"
                        required 
                        autocomplete="email"
                    >
                </div>
                <div class="helper-text">Usa la tua email aziendale o personale</div>
            </div>
            
            <!-- DATA DI NASCITA -->
            <div class="form-group">
                <label class="form-label" for="registerBirthDate">Data di Nascita</label>
                <div class="input-wrapper">
                    <span class="input-icon">üìÖ</span>
                    <input 
                        type="date" 
                        id="registerBirthDate" 
                        class="form-input"
                        required 
                        max=""
                    >
                </div>
                <div class="helper-text">Per evitare omonimi</div>
            </div>
            
            <!-- LUOGO DI NASCITA -->
            <div class="form-group">
                <label class="form-label" for="registerBirthPlace">Luogo di Nascita</label>
                <div class="input-wrapper">
                    <span class="input-icon">üèõÔ∏è</span>
                    <input 
                        type="text" 
                        id="registerBirthPlace" 
                        class="form-input"
                        placeholder="Roma (RM)"
                        required 
                        autocomplete="address-level2"
                    >
                </div>
                <div class="helper-text">Citt√† e provincia (es. Roma RM)</div>
            </div>
            
            <div class="form-group">
                <label class="form-label" for="registerPassword">Password</label>
                <div class="input-wrapper">
                    <span class="input-icon">üîí</span>
                    <input 
                        type="password" 
                        id="registerPassword" 
                        class="form-input"
                        placeholder="Crea una password sicura"
                        required 
                        autocomplete="new-password"
                        minlength="8"
                    >
                    <button type="button" class="password-toggle" onclick="togglePassword('registerPassword', this)">
                        üëÅÔ∏è
                    </button>
                </div>
                <div class="helper-text">Minimo 8 caratteri, usa maiuscole e numeri</div>
            </div>
            
            <div class="form-group">
                <label class="form-label" for="confirmPassword">Conferma Password</label>
                <div class="input-wrapper">
                    <span class="input-icon">üîí</span>
                    <input 
                        type="password" 
                        id="confirmPassword" 
                        class="form-input"
                        placeholder="Ripeti la password"
                        required 
                        autocomplete="new-password"
                        minlength="8"
                    >
                    <button type="button" class="password-toggle" onclick="togglePassword('confirmPassword', this)">
                        üëÅÔ∏è
                    </button>
                </div>
            </div>
            
            <button type="submit" class="auth-button" id="registerBtn">
                <span id="registerBtnText">üöÄ Registrati</span>
            </button>
        </form>
        
        <!-- LINK TORNA ALLA HOME -->
        <div class="auth-link">
            <a href="index.html">
                ‚Üê Torna alla home
            </a>
        </div>
    </div>

    <script>
        // üîß CONFIGURAZIONE APPWRITE
        const { Client, Account, Databases, ID, Query } = Appwrite;

        const client = new Client()
            .setEndpoint('https://cloud.appwrite.io/v1')
            .setProject('688db9670010e3113d56');

        const account = new Account(client);
        const databases = new Databases(client);

        const DATABASE_ID = '688dbfaf001fcce68c0f';
        const COLLECTIONS = {
            profiles: '688dc04f0034554d752f',
            notizie: '688e02b3000595a16b2c',
            convenzioni: '688e03f0001958f71d9e',
            organico: '688e0501000254ad0966'
        };

        // üéØ STATO APPLICAZIONE
        let currentMode = 'login';

        // üõ†Ô∏è UTILITIES
        const Utils = {
            showMessage: (text, type = 'info') => {
                const messagesDiv = document.getElementById('messages');
                if (messagesDiv) {
                    messagesDiv.innerHTML = `<div class="message message-${type}">${text}</div>`;
                    
                    if (type !== 'error') {
                        setTimeout(() => {
                            messagesDiv.innerHTML = '';
                        }, 5000);
                    }
                }
            },

            setLoading: (buttonId, loading) => {
                const btn = document.getElementById(buttonId);
                const btnText = document.getElementById(buttonId.replace('Btn', 'BtnText'));
                
                if (btn && btnText) {
                    btn.disabled = loading;
                    if (loading) {
                        btnText.innerHTML = '<span class="loading-spinner"></span>Elaborazione...';
                    } else {
                        btnText.innerHTML = buttonId === 'loginBtn' ? 'üîê Accedi' : 'üöÄ Registrati';
                    }
                }
            },

            isValidEmail: (email) => {
                return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
            },

            safeRedirect: (url, delay = 1500) => {
                console.log(`üîÑ Redirect a: ${url} tra ${delay}ms`);
                setTimeout(() => {
                    window.location.href = url;
                }, delay);
            }
        };

        // üîÑ SWITCH TRA LOGIN E REGISTRAZIONE
        function switchToLogin() {
            currentMode = 'login';
            
            // Update tabs
            document.getElementById('loginTab').classList.add('active');
            document.getElementById('registerTab').classList.remove('active');
            
            // Update forms
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('registerForm').style.display = 'none';
            
            // Update header
            document.getElementById('authTitle').textContent = 'Accedi';
            document.getElementById('authSubtitle').textContent = 'Inserisci le tue credenziali';
            
            // Clear messages
            document.getElementById('messages').innerHTML = '';
            
            // Focus
            setTimeout(() => {
                document.getElementById('loginEmail').focus();
            }, 100);
        }

        function switchToRegister() {
            currentMode = 'register';
            
            // Update tabs
            document.getElementById('loginTab').classList.remove('active');
            document.getElementById('registerTab').classList.add('active');
            
            // Update forms
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('registerForm').style.display = 'block';
            
            // Update header
            document.getElementById('authTitle').textContent = 'Registrati';
            document.getElementById('authSubtitle').textContent = 'Crea il tuo account';
            
            // Clear messages
            document.getElementById('messages').innerHTML = '';
            
            // Focus
            setTimeout(() => {
                document.getElementById('registerName').focus();
            }, 100);
        }

        // üëÅÔ∏è TOGGLE PASSWORD
        function togglePassword(inputId, button) {
            const input = document.getElementById(inputId);
            const isPassword = input.type === 'password';
            
            input.type = isPassword ? 'text' : 'password';
            button.textContent = isPassword ? 'üôà' : 'üëÅÔ∏è';
        }

        // üîê AUTH MANAGER
        const AuthManager = {
            // Get user profile and role
            getUserProfile: async (userId) => {
                try {
                    console.log('üîç Caricamento profilo per:', userId);
                    
                    const profile = await databases.getDocument(
                        DATABASE_ID,
                        COLLECTIONS.profiles,
                        userId
                    );
                    
                    console.log('üë§ Profilo caricato:', profile);
                    
                    // Normalizza i ruoli
                    let ruoli = [];
                    if (Array.isArray(profile.ruoli)) {
                        ruoli = profile.ruoli;
                    } else if (typeof profile.ruoli === 'string') {
                        ruoli = [profile.ruoli];
                    } else {
                        ruoli = ['USER']; // Default fallback
                    }
                    
                    const isDirigente = ruoli.includes('DIRIGENTE');
                    const isAdmin = ruoli.includes('ADMIN');
                    
                    console.log('üéØ Ruoli analizzati:', {
                        ruoli_raw: profile.ruoli,
                        ruoli_normalized: ruoli,
                        isDirigente: isDirigente,
                        isAdmin: isAdmin
                    });
                    
                    return {
                        ...profile,
                        ruoli: ruoli,
                        isDirigente: isDirigente,
                        isAdmin: isAdmin
                    };
                    
                } catch (error) {
                    console.warn('‚ö†Ô∏è Profilo non trovato, creazione automatica...');
                    console.log('üîß Errore dettagli:', error);
                    
                    // Crea profilo basic per nuovi utenti
                    try {
                        const userData = await account.get();
                        console.log('üë§ Dati utente Appwrite:', userData);
                        
                        const newProfile = await databases.createDocument(
                            DATABASE_ID,
                            COLLECTIONS.profiles,
                            userId,
                            {
                                nome: userData.name || 'Nuovo Utente',
                                email: userData.email,
                                ruoli: ['USER'], // Array di default
                                created_at: new Date().toISOString(),
                                data_nascita: null,
                                luogo_nascita: null
                            }
                        );
                        
                        console.log('‚úÖ Profilo USER creato automaticamente:', newProfile);
                        
                        return {
                            ...newProfile,
                            ruoli: ['USER'],
                            isDirigente: false,
                            isAdmin: false
                        };
                        
                    } catch (createError) {
                        console.error('‚ùå Errore creazione profilo automatico:', createError);
                        
                        // Fallback completo - profilo minimale in memoria
                        return {
                            ruoli: ['USER'],
                            isDirigente: false,
                            isAdmin: false,
                            nome: 'Utente',
                            email: '',
                            $id: userId
                        };
                    }
                }
            },

            // Determine redirect URL based on role with detailed logging
            getRedirectUrl: (userProfile) => {
                console.log('üéØ ANALISI REDIRECT - Profilo completo:', userProfile);
                
                const ruoli = userProfile.ruoli || [];
                const isDirigente = userProfile.isDirigente || ruoli.includes('DIRIGENTE');
                const isAdmin = userProfile.isAdmin || ruoli.includes('ADMIN');
                
                console.log('üîç LOGIC REDIRECT:', {
                    ruoli_array: ruoli,
                    isDirigente: isDirigente,
                    isAdmin: isAdmin,
                    check_dirigente: ruoli.includes('DIRIGENTE'),
                    check_admin: ruoli.includes('ADMIN')
                });
                
                // Priorit√†: ADMIN > DIRIGENTE > USER
                if (isAdmin) {
                    console.log('üëë REDIRECT ADMIN ‚Üí app/home_dirigenti.html');
                    return 'app/home_dirigenti.html';
                } else if (isDirigente) {
                    console.log('üìã REDIRECT DIRIGENTE ‚Üí app/home_dirigenti.html');
                    return 'app/home_dirigenti.html';
                } else {
                    console.log('üë§ REDIRECT USER ‚Üí app/home.html');
                    return 'app/home.html';
                }
            },

            // Handle login
            handleLogin: async () => {
                try {
                    Utils.setLoading('loginBtn', true);
                    
                    const email = document.getElementById('loginEmail').value.trim();
                    const password = document.getElementById('loginPassword').value;
                    
                    // Validations
                    if (!email || !password) {
                        throw new Error('Inserisci email e password');
                    }
                    
                    if (!Utils.isValidEmail(email)) {
                        throw new Error('Email non valida');
                    }
                    
                    console.log('üîê Tentativo login per:', email);
                    
                    // Login with Appwrite
                    const session = await account.createEmailSession(email, password);
                    console.log('‚úÖ Sessione creata:', session);
                    
                    // Get user info
                    const user = await account.get();
                    console.log('üë§ User data:', user);
                    
                    Utils.showMessage('‚úÖ Accesso riuscito!', 'success');
                    
                    // Get user profile and redirect
                    const userProfile = await AuthManager.getUserProfile(user.$id);
                    const redirectUrl = AuthManager.getRedirectUrl(userProfile);
                    
                    console.log('üöÄ Redirect a:', redirectUrl);
                    Utils.safeRedirect(redirectUrl, 2000);
                    
                } catch (error) {
                    console.error('‚ùå Errore login:', error);
                    
                    let errorMessage = '‚ùå Errore di accesso';
                    
                    if (error.message.includes('Invalid credentials')) {
                        errorMessage = '‚ùå Email o password errati';
                    } else if (error.message.includes('User not found')) {
                        errorMessage = 'üë§ Utente non trovato. Registrati prima';
                    } else if (error.message.includes('Too many requests')) {
                        errorMessage = '‚è∞ Troppi tentativi. Riprova tra qualche minuto';
                    } else if (error.message) {
                        errorMessage = `‚ùå ${error.message}`;
                    }
                    
                    Utils.showMessage(errorMessage, 'error');
                } finally {
                    Utils.setLoading('loginBtn', false);
                }
            },

            // Handle registration
            handleRegister: async () => {
                try {
                    Utils.setLoading('registerBtn', true);
                    
                    const name = document.getElementById('registerName').value.trim();
                    const email = document.getElementById('registerEmail').value.trim();
                    const birthDate = document.getElementById('registerBirthDate').value;
                    const birthPlace = document.getElementById('registerBirthPlace').value.trim();
                    const password = document.getElementById('registerPassword').value;
                    const confirmPassword = document.getElementById('confirmPassword').value;
                    
                    // Validazioni complete
                    if (!name || !email || !birthDate || !birthPlace || !password || !confirmPassword) {
                        throw new Error('Compila tutti i campi obbligatori');
                    }
                    
                    if (!Utils.isValidEmail(email)) {
                        throw new Error('Email non valida');
                    }
                    
                    if (name.split(' ').length < 2) {
                        throw new Error('Inserisci nome e cognome completi');
                    }
                    
                    // Validazione data di nascita
                    const today = new Date();
                    const birth = new Date(birthDate);
                    const age = today.getFullYear() - birth.getFullYear();
                    
                    if (birth > today) {
                        throw new Error('Data di nascita non pu√≤ essere futura');
                    }
                    
                    if (age < 18) {
                        throw new Error('Devi essere maggiorenne per registrarti');
                    }
                    
                    if (age > 100) {
                        throw new Error('Data di nascita non valida');
                    }
                    
                    // Validazione luogo di nascita
                    if (birthPlace.length < 3) {
                        throw new Error('Luogo di nascita troppo corto');
                    }
                    
                    if (password.length < 8) {
                        throw new Error('Password troppo corta (minimo 8 caratteri)');
                    }
                    
                    // Validazione forza password
                    const passwordStrength = getPasswordStrength(password);
                    if (passwordStrength === 'weak') {
                        throw new Error('Password troppo debole. Usa maiuscole, minuscole e numeri');
                    }
                    
                    if (password !== confirmPassword) {
                        throw new Error('Le password non coincidono');
                    }
                    
                    console.log('üìù Tentativo registrazione per:', email);
                    console.log('üìã Dati:', { name, email, birthDate, birthPlace });
                    
                    // Create account with Appwrite
                    const user = await account.create(ID.unique(), email, password, name);
                    console.log('‚úÖ Account Appwrite creato:', user);
                    
                    // Create session immediately
                    const session = await account.createEmailSession(email, password);
                    console.log('‚úÖ Sessione creata:', session);
                    
                    // Separa nome e cognome per il database
                    const nameParts = name.trim().split(' ');
                    const firstName = nameParts[0];
                    const lastName = nameParts.slice(1).join(' ');
                    
                    // Create complete profile in database
                    try {
                        const profileData = {
                            nome: firstName,
                            cognome: lastName,
                            email: email,
                            data_nascita: birthDate,
                            luogo_nascita: birthPlace,
                            ruoli: ['USER'], // Array per nuovo utente
                            created_at: new Date().toISOString(),
                            last_login: new Date().toISOString()
                        };
                        
                        console.log('üíæ Creazione profilo con dati:', profileData);
                        
                        const profile = await databases.createDocument(
                            DATABASE_ID,
                            COLLECTIONS.profiles,
                            user.$id,
                            profileData
                        );
                        
                        console.log('‚úÖ Profilo completo creato:', profile);
                        
                    } catch (profileError) {
                        console.error('‚ùå Errore creazione profilo dettagliato:', profileError);
                        
                        // Fallback: profilo minimale
                        try {
                            await databases.createDocument(
                                DATABASE_ID,
                                COLLECTIONS.profiles,
                                user.$id,
                                {
                                    nome: name,
                                    email: email,
                                    ruoli: ['USER'],
                                    created_at: new Date().toISOString()
                                }
                            );
                            console.log('‚úÖ Profilo minimale creato come fallback');
                        } catch (fallbackError) {
                            console.warn('‚ö†Ô∏è Impossibile creare profilo, continuando...');
                        }
                    }
                    
                    Utils.showMessage('üéâ Registrazione completata! Benvenuto nella famiglia!', 'success');
                    
                    // Redirect to user page (nuovi utenti sono sempre USER)
                    console.log('üöÄ Redirect nuovo utente ‚Üí app/home.html');
                    Utils.safeRedirect('app/home.html', 2500);
                    
                } catch (error) {
                    console.error('‚ùå Errore registrazione:', error);
                    
                    let errorMessage = '‚ùå Errore durante la registrazione';
                    
                    if (error.message.includes('user with the same id, email')) {
                        errorMessage = 'üìß Email gi√† registrata. Prova ad accedere';
                    } else if (error.message.includes('Password must be')) {
                        errorMessage = 'üîí Password troppo debole. Usa almeno 8 caratteri';
                    } else if (error.message.includes('Invalid email')) {
                        errorMessage = 'üìß Email non valida';
                    } else if (error.message.includes('Rate limit')) {
                        errorMessage = '‚è∞ Troppi tentativi. Riprova tra qualche minuto';
                    } else if (error.message) {
                        errorMessage = `‚ùå ${error.message}`;
                    }
                    
                    Utils.showMessage(errorMessage, 'error');
                } finally {
                    Utils.setLoading('registerBtn', false);
                }
            }
        };

        // üöÄ INIZIALIZZAZIONE
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üöÄ MyApp Auth Unificato - Appwrite v1.0');
            
            // Set max date for birth date (18 years ago)
            const today = new Date();
            const maxDate = new Date(today.getFullYear() - 18, today.getMonth(), today.getDate());
            const birthDateInput = document.getElementById('registerBirthDate');
            if (birthDateInput) {
                birthDateInput.max = maxDate.toISOString().split('T')[0];
                
                // Set reasonable min date (100 years ago)
                const minDate = new Date(today.getFullYear() - 100, today.getMonth(), today.getDate());
                birthDateInput.min = minDate.toISOString().split('T')[0];
            }
            
            // Check existing session
            account.get().then(user => {
                console.log('‚úÖ Sessione esistente trovata per:', user.email);
                Utils.showMessage('üîÑ Sessione attiva rilevata. Reindirizzamento...', 'info');
                
                // Get profile and redirect
                AuthManager.getUserProfile(user.$id).then(profile => {
                    const redirectUrl = AuthManager.getRedirectUrl(profile);
                    Utils.safeRedirect(redirectUrl, 1500);
                });
                
            }).catch(() => {
                console.log('üìù Nessuna sessione attiva');
            });
            
            // Form handlers
            const loginForm = document.getElementById('loginForm');
            const registerForm = document.getElementById('registerForm');
            
            if (loginForm) {
                loginForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    AuthManager.handleLogin();
                });
            }
            
            if (registerForm) {
                registerForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    AuthManager.handleRegister();
                });
            }
            
            // Keyboard navigation
            setupKeyboardNavigation();
            
            // Focus management
            setTimeout(() => {
                if (currentMode === 'login') {
                    document.getElementById('loginEmail')?.focus();
                } else {
                    document.getElementById('registerName')?.focus();
                }
            }, 300);
            
            console.log('‚úÖ Auth system ready');
        });

        // ‚å®Ô∏è KEYBOARD NAVIGATION
        function setupKeyboardNavigation() {
            // Login form navigation
            const loginEmail = document.getElementById('loginEmail');
            const loginPassword = document.getElementById('loginPassword');
            
            if (loginEmail && loginPassword) {
                loginEmail.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        loginPassword.focus();
                    }
                });
                
                loginPassword.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        document.getElementById('loginForm').dispatchEvent(new Event('submit'));
                    }
                });
            }
            
            // Register form navigation
            const registerInputs = [
                'registerName',
                'registerEmail',
                'registerBirthDate',
                'registerBirthPlace',
                'registerPassword',
                'confirmPassword'
            ];
            
            registerInputs.forEach((inputId, index) => {
                const input = document.getElementById(inputId);
                if (input) {
                    input.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            
                            if (index < registerInputs.length - 1) {
                                // Move to next input
                                document.getElementById(registerInputs[index + 1])?.focus();
                            } else {
                                // Submit form
                                document.getElementById('registerForm').dispatchEvent(new Event('submit'));
                            }
                        }
                    });
                }
            });

            // Tab switching with keyboard
            document.addEventListener('keydown', (e) => {
                if (e.ctrlKey || e.metaKey) {
                    if (e.key === '1') {
                        e.preventDefault();
                        switchToLogin();
                    } else if (e.key === '2') {
                        e.preventDefault();
                        switchToRegister();
                    }
                }
            });
        }

        // üîó CONNECTION HANDLING
        window.addEventListener('online', () => {
            console.log('üîó Connessione ripristinata');
            Utils.showMessage('üîó Connessione ripristinata', 'success');
        });

        window.addEventListener('offline', () => {
            console.log('üì° Connessione persa');
            Utils.showMessage('üì° Connessione persa. Controlla la tua rete', 'error');
        });

        // üîß REAL-TIME VALIDATION
        function setupRealTimeValidation() {
            // Email validation
            const emailInputs = ['loginEmail', 'registerEmail'];
            emailInputs.forEach(inputId => {
                const input = document.getElementById(inputId);
                if (input) {
                    input.addEventListener('blur', () => {
                        const email = input.value.trim();
                        if (email && !Utils.isValidEmail(email)) {
                            input.style.borderColor = '#dc2626';
                        } else if (email) {
                            input.style.borderColor = '#16a34a';
                        } else {
                            input.style.borderColor = '#e5e7eb';
                        }
                    });
                }
            });
            
            // Name validation
            const nameInput = document.getElementById('registerName');
            if (nameInput) {
                nameInput.addEventListener('blur', () => {
                    const name = nameInput.value.trim();
                    const nameParts = name.split(' ');
                    
                    if (name && nameParts.length < 2) {
                        nameInput.style.borderColor = '#f59e0b';
                    } else if (name && nameParts.length >= 2) {
                        nameInput.style.borderColor = '#16a34a';
                    } else {
                        nameInput.style.borderColor = '#e5e7eb';
                    }
                });
            }
            
            // Birth date validation
            const birthDateInput = document.getElementById('registerBirthDate');
            if (birthDateInput) {
                birthDateInput.addEventListener('change', () => {
                    const birthDate = new Date(birthDateInput.value);
                    const today = new Date();
                    const age = today.getFullYear() - birthDate.getFullYear();
                    
                    if (age < 18 || age > 100 || birthDate > today) {
                        birthDateInput.style.borderColor = '#dc2626';
                    } else {
                        birthDateInput.style.borderColor = '#16a34a';
                    }
                });
            }
            
            // Birth place validation
            const birthPlaceInput = document.getElementById('registerBirthPlace');
            if (birthPlaceInput) {
                birthPlaceInput.addEventListener('blur', () => {
                    const birthPlace = birthPlaceInput.value.trim();
                    
                    if (birthPlace && birthPlace.length < 3) {
                        birthPlaceInput.style.borderColor = '#dc2626';
                    } else if (birthPlace && birthPlace.length >= 3) {
                        birthPlaceInput.style.borderColor = '#16a34a';
                    } else {
                        birthPlaceInput.style.borderColor = '#e5e7eb';
                    }
                });
            }
            
            // Password strength indicator
            const registerPassword = document.getElementById('registerPassword');
            if (registerPassword) {
                registerPassword.addEventListener('input', () => {
                    const password = registerPassword.value;
                    const strength = getPasswordStrength(password);
                    
                    // Update border color based on strength
                    if (strength === 'weak') {
                        registerPassword.style.borderColor = '#dc2626';
                    } else if (strength === 'medium') {
                        registerPassword.style.borderColor = '#f59e0b';
                    } else if (strength === 'strong') {
                        registerPassword.style.borderColor = '#16a34a';
                    }
                });
            }
            
            // Confirm password matching
            const confirmPassword = document.getElementById('confirmPassword');
            if (confirmPassword && registerPassword) {
                const checkPasswordMatch = () => {
                    const password = registerPassword.value;
                    const confirm = confirmPassword.value;
                    
                    if (confirm && password !== confirm) {
                        confirmPassword.style.borderColor = '#dc2626';
                    } else if (confirm && password === confirm) {
                        confirmPassword.style.borderColor = '#16a34a';
                    } else {
                        confirmPassword.style.borderColor = '#e5e7eb';
                    }
                };
                
                confirmPassword.addEventListener('input', checkPasswordMatch);
                registerPassword.addEventListener('input', checkPasswordMatch);
            }
        } registerPassword = document.getElementById('registerPassword');
            if (registerPassword) {
                registerPassword.addEventListener('input', () => {
                    const password = registerPassword.value;
                    const strength = getPasswordStrength(password);
                    
                    // Update border color based on strength
                    if (strength === 'weak') {
                        registerPassword.style.borderColor = '#dc2626';
                    } else if (strength === 'medium') {
                        registerPassword.style.borderColor = '#f59e0b';
                    } else if (strength === 'strong') {
                        registerPassword.style.borderColor = '#16a34a';
                    }
                });
            }
            
            // Confirm password matching
            const confirmPassword = document.getElementById('confirmPassword');
            if (confirmPassword && registerPassword) {
                const checkPasswordMatch = () => {
                    const password = registerPassword.value;
                    const confirm = confirmPassword.value;
                    
                    if (confirm && password !== confirm) {
                        confirmPassword.style.borderColor = '#dc2626';
                    } else if (confirm && password === confirm) {
                        confirmPassword.style.borderColor = '#16a34a';
                    } else {
                        confirmPassword.style.borderColor = '#e5e7eb';
                    }
                };
                
                confirmPassword.addEventListener('input', checkPasswordMatch);
                registerPassword.addEventListener('input', checkPasswordMatch);
            }
        }

        function getPasswordStrength(password) {
            if (password.length < 6) return 'weak';
            if (password.length < 8) return 'weak';
            
            let score = 0;
            if (password.match(/[a-z]/)) score++;
            if (password.match(/[A-Z]/)) score++;
            if (password.match(/[0-9]/)) score++;
            if (password.match(/[^a-zA-Z0-9]/)) score++;
            if (password.length >= 12) score++;
            
            if (score < 3) return 'weak';
            if (score < 5) return 'medium';
            return 'strong';
        }

        // Initialize real-time validation
        setTimeout(setupRealTimeValidation, 1000);

        // üéØ URL PARAMETER HANDLING
        function handleUrlParameters() {
            const urlParams = new URLSearchParams(window.location.search);
            
            // Handle registration mode
            if (urlParams.get('mode') === 'register') {
                switchToRegister();
            }
            
            // Handle messages
            const message = urlParams.get('message');
            const messageType = urlParams.get('type') || 'info';
            
            if (message) {
                Utils.showMessage(decodeURIComponent(message), messageType);
                
                // Clean URL
                setTimeout(() => {
                    window.history.replaceState({}, document.title, window.location.pathname);
                }, 3000);
            }
            
            // Handle role-based redirects from URL
            const redirectRole = urlParams.get('role');
            if (redirectRole) {
                console.log('üéØ Redirect role specificato nell\'URL:', redirectRole);
            }
        }

        // Handle URL parameters on load
        setTimeout(handleUrlParameters, 500);

        // üß™ DEBUG FUNCTIONS FOR TESTING
        function debugUserRole(userId = null) {
            if (!userId) {
                account.get().then(user => {
                    debugUserRole(user.$id);
                }).catch(() => {
                    console.log('‚ùå Nessun utente loggato per debug');
                });
                return;
            }
            
            console.log('üß™ DEBUG: Analisi ruolo utente', userId);
            
            AuthManager.getUserProfile(userId).then(profile => {
                console.log('üìã PROFILO COMPLETO:', profile);
                console.log('üéØ URL REDIRECT:', AuthManager.getRedirectUrl(profile));
                console.log('‚úÖ Debug completato');
            }).catch(error => {
                console.error('‚ùå Errore debug:', error);
            });
        }

        // Make debug function available globally
        window.debugUserRole = debugUserRole;
        window.AuthManager = AuthManager;

        // üîÑ SESSION MONITORING
        function startSessionMonitoring() {
            setInterval(async () => {
                try {
                    await account.get();
                    // Session is valid
                } catch (error) {
                    console.warn('‚ö†Ô∏è Sessione persa, redirect al login...');
                    if (window.location.pathname !== '/login.html' && window.location.pathname !== '/') {
                        window.location.href = 'login.html?message=Sessione scaduta&type=info';
                    }
                }
            }, 300000); // Check every 5 minutes
        }

        // Start session monitoring after login
        setTimeout(startSessionMonitoring, 10000);

        // üé® ENHANCED UI FEEDBACK
        function enhanceFormFeedback() {
            // Add loading states to all inputs during form submission
            const forms = ['loginForm', 'registerForm'];
            
            forms.forEach(formId => {
                const form = document.getElementById(formId);
                if (form) {
                    form.addEventListener('submit', () => {
                        const inputs = form.querySelectorAll('input');
                        inputs.forEach(input => {
                            input.style.opacity = '0.7';
                            input.disabled = true;
                        });
                        
                        // Re-enable after 10 seconds as fallback
                        setTimeout(() => {
                            inputs.forEach(input => {
                                input.style.opacity = '1';
                                input.disabled = false;
                            });
                        }, 10000);
                    });
                }
            });
        }

        setTimeout(enhanceFormFeedback, 1000);

        // üì± MOBILE OPTIMIZATIONS
        function setupMobileOptimizations() {
            // Prevent zoom on input focus for iOS
            if (/iPad|iPhone|iPod/.test(navigator.userAgent)) {
                const inputs = document.querySelectorAll('input');
                inputs.forEach(input => {
                    input.addEventListener('focus', () => {
                        input.style.fontSize = '16px';
                    });
                    input.addEventListener('blur', () => {
                        input.style.fontSize = '1rem';
                    });
                });
            }
            
            // Enhanced touch targets
            const buttons = document.querySelectorAll('button, .auth-tab');
            buttons.forEach(button => {
                button.style.minHeight = '44px';
                button.style.minWidth = '44px';
            });
        }

        setTimeout(setupMobileOptimizations, 500);

        // üîç ACCESSIBILITY ENHANCEMENTS
        function setupAccessibility() {
            // ARIA labels for screen readers
            const loginEmail = document.getElementById('loginEmail');
            const loginPassword = document.getElementById('loginPassword');
            
            if (loginEmail) {
                loginEmail.setAttribute('aria-describedby', 'email-help');
                loginEmail.setAttribute('aria-label', 'Indirizzo email per accesso');
            }
            
            if (loginPassword) {
                loginPassword.setAttribute('aria-describedby', 'password-help');
                loginPassword.setAttribute('aria-label', 'Password per accesso');
            }
            
            // Register form accessibility
            const registerInputs = {
                'registerName': 'Nome e cognome completi',
                'registerEmail': 'Indirizzo email per registrazione',
                'registerBirthDate': 'Data di nascita per identificazione',
                'registerBirthPlace': 'Luogo di nascita per identificazione',
                'registerPassword': 'Password per nuovo account',
                'confirmPassword': 'Conferma della password'
            };
            
            Object.entries(registerInputs).forEach(([id, label]) => {
                const input = document.getElementById(id);
                if (input) {
                    input.setAttribute('aria-label', label);
                }
            });
            
            // High contrast mode detection
            if (window.matchMedia('(prefers-contrast: high)').matches) {
                document.body.classList.add('high-contrast');
            }
        }

        setTimeout(setupAccessibility, 500);

        // üìä ANALYTICS & MONITORING
        function logAuthEvent(event, details = {}) {
            const timestamp = new Date().toISOString();
            const eventData = {
                timestamp,
                event,
                userAgent: navigator.userAgent,
                ...details
            };
            
            console.log('üìä AUTH EVENT:', eventData);
            
            // Here you could send to analytics service
            // analytics.track('auth_event', eventData);
        }

        // Log when forms are used
        document.getElementById('loginForm')?.addEventListener('submit', () => {
            logAuthEvent('login_attempt');
        });

        document.getElementById('registerForm')?.addEventListener('submit', () => {
            logAuthEvent('register_attempt');
        });

        // Log tab switches
        window.switchToLogin = function() {
            logAuthEvent('switch_to_login');
            currentMode = 'login';
            
            // Update tabs
            document.getElementById('loginTab').classList.add('active');
            document.getElementById('registerTab').classList.remove('active');
            
            // Update forms
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('registerForm').style.display = 'none';
            
            // Update header
            document.getElementById('authTitle').textContent = 'Accedi';
            document.getElementById('authSubtitle').textContent = 'Inserisci le tue credenziali';
            
            // Clear messages
            document.getElementById('messages').innerHTML = '';
            
            // Focus
            setTimeout(() => {
                document.getElementById('loginEmail')?.focus();
            }, 100);
        };

        window.switchToRegister = function() {
            logAuthEvent('switch_to_register');
            currentMode = 'register';
            
            // Update tabs
            document.getElementById('loginTab').classList.remove('active');
            document.getElementById('registerTab').classList.add('active');
            
            // Update forms
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('registerForm').style.display = 'block';
            
            // Update header
            document.getElementById('authTitle').textContent = 'Registrati';
            document.getElementById('authSubtitle').textContent = 'Crea il tuo account';
            
            // Clear messages
            document.getElementById('messages').innerHTML = '';
            
            // Focus
            setTimeout(() => {
                document.getElementById('registerName')?.focus();
            }, 100);
        };

        console.log('üéØ MyApp Auth System - Fully Loaded! üöÄ');
        console.log('üîß Debug disponibile: debugUserRole(), AuthManager');
        console.log('üé® Design: Aurora Boreale 2025');
        console.log('‚ö° Platform: Appwrite Cloud');
    </script>
</body>
</html>